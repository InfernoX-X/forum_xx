<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribute | <%= siteTitle %></title>
    <%- include("../partials/variables") %>

    <style>
        :root{
            --bg: var(--cx-bg);
            --surface: var(--cx-surface);
            --border: var(--cx-border);
            --text-main: var(--cx-text-main);
            --text-muted: var(--cx-text-muted);
            --input-bg: var(--cx-input-bg);
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-family); line-height: 1.5; }
        
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .page-header { margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .page-header h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
        .page-header p { color: var(--text-muted); }

        /* Grid Layout */
        .contribute-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; align-items: start; }

        @media (max-width: 900px) {
            .contribute-grid { grid-template-columns: 1fr; }
        }

        /* Common Form Styles */
        .card { background: var(--surface); border: 1px solid var(--border); padding: 30px; border-radius: 8px; }
        .card h3 { font-size: 0.75rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 20px; text-transform: uppercase; }
        
        label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .container input, textarea, select { 
            width: 100%; background: var(--input-bg); border: 1px solid var(--border); 
            color: var(--white); padding: 12px; margin-bottom: 18px; border-radius: 4px; font-family: inherit;
        }
        .container input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; }

        .btn-accent { 
            background: var(--accent); color: var(--white); border: none; padding: 12px 30px; 
            font-weight: 700; border-radius: 4px; cursor: pointer; transition: 0.2s; width: 100%;
        }
        .btn-accent:hover { filter: brightness(1.2); }

        /* Multi-select Forum Container */
        .forum-selection-container {
            max-height: 250px; overflow-y: auto; background: var(--input-bg);
            padding: 15px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 18px;
        }
        .category-group-header {
            background: #1a1a1a; color: var(--accent); font-size: 0.65rem;
            font-weight: 800; padding: 4px 10px; margin: 10px 0 8px 0;
            border-left: 3px solid var(--accent); text-transform: uppercase;
        }
        .forum-item {
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem;
            cursor: pointer; padding: 5px; color: #ccc;
            transition: all 0.2s ease;
            background: #080808;
        }
        .forum-item:hover { 
            border-color: #444 !important;
            background: #111 !important; 
            color: var(--white); }

        .forum-item:has(input:checked) {
            border-color: var(--accent) !important;
            background: rgba(249, 55, 66, 0.1) !important;
            color: var(--accent) !important;
        }
        
        .forum-item input[type="checkbox"] {
            display: none;
        }

        /* File Upload */
        .file-label { 
            display: inline-block; background: #222; padding: 10px 15px; border-radius: 4px; 
            font-size: 0.75rem; cursor: pointer; border: 1px solid var(--border); margin-bottom: 18px;
        }
        
        .hidden-item {
            display: none !important;
        }
    </style>
    <style>
        /* Container for the search and pills */
        .tag-system {
            background: #111;
            border: 1px solid #222;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* The Pills */
        .tag-pill {
            background: var(--accent) !important; /* Use your red accent */
            color: white !important;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none !important;
        }

        .tag-pill:hover {
            background: rgba(255, 170, 0, 0.25);
        }

        .tag-pill span {
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
        }

        /* The Search Input */
        #tagSearchInput {
            background: var(--input-bg);
            border: 1px solid #333;
            color: var(--white);
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            outline: none;
        }

        #tagSearchInput:focus {
            border-color: var(--accent);
        }

        #tagDropdown {
            display: none; 
            position: absolute; 
            width: 100%; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            z-index: 999; /* Ensure it floats above other inputs */
            max-height: 250px; 
            overflow-y: auto;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* Individual items in dropdown */
        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #aaa;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #222;
            color: var(--white);
        }

        .dropdown-create-btn {
            color: #ffaa00;
            font-weight: bold;
            border-top: 1px solid #222;
        }
        
        .tag-pill, .dropdown-item {
            text-transform: capitalize;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<%- include("../partials/navBar") %>

<div class="container">
    <header class="page-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h1>CONTRIBUTE</h1>
            <button id="infoBtn" style="background: var(--surface); border: 1px solid var(--border); color: var(--accent); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s;">!</button>
        </div>
        <p>Expand the community by sharing new content or creating new tags.</p>
    </header>

    <div id="guideModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px);">
        <div class="card" style="max-width: 700px; width: 100%; position: relative; border-color: var(--accent); box-shadow: 0 10px 40px rgba(0,0,0,0.5); padding: 0;">
            
            <div style="padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin-bottom: 0;">üöÄ Full Contribution Guide</h3>
                <button id="closeGuide" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>

            <div style="padding: 30px; max-height: 75vh; overflow-y: auto;">
                
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--accent); margin-bottom: 12px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">1. Sharing New Content</h4>
                    
                    <p style="font-size: 0.9rem; margin-bottom: 10px;"><strong style="color: var(--white);">üè∑Ô∏è Titles & Tags:</strong></p>
                    <ul style="list-style: none; color: #ccc; font-size: 0.85rem; padding-left: 10px; border-left: 1px solid #333; margin-bottom: 15px;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Naming:</strong> Use <em>"Original Video Title (Performer Name)"</em>.</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Multi-Tagging:</strong> You can select multiple categories. Use the <strong>Search Bar</strong> inside the selection box to find specific tags instantly.</li>
                    </ul>

                    <p style="font-size: 0.9rem; margin-bottom: 10px;"><strong style="color: var(--white);">üîó Video Links & Media:</strong></p>
                    <ul style="list-style: none; color: #ccc; font-size: 0.85rem; padding-left: 10px; border-left: 1px solid #333;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Video URL:</strong> Paste the full link to the source (e.g., YouTube, Vimeo, or other hosting sites). <strong>This is required.</strong></li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Previews:</strong> Maximum of 5 images. If using URLs, ensure they are direct links (ending in <code>.jpg</code>, <code>.png</code>).</li>
                    </ul>
                </div>

            </div>

            <div style="padding: 20px 30px; border-top: 1px solid var(--border); background: var(--surface);">
                <button id="closeGuideBtn" class="btn-accent">I'VE READ THE RULES - LET'S GO</button>
            </div>
        </div>
    </div>

    <div class="contribute-grid">
        
        <section class="card">
            <h3>Create New Content</h3>
            <form action="/forum/posts/create" method="post" enctype="multipart/form-data" onsubmit="return validateMedia()">
                <label>1. Name</label>
                <input type="text" name="title" placeholder="Original Title with (Female Performer's name)" required>

                <label>2. Add Tags</label>
                <div class="tag-system">
                    <div id="pillContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                    
                    <div class="search-wrapper" style="position: relative;">
                        <input type="text" id="tagSearchInput" placeholder="Search or type new tag..." autocomplete="off">
                        
                        <div id="tagDropdown" style="display: none; position: absolute; width: 100%; background: #1a1a1a; border: 1px solid #333; z-index: 100; max-height: 200px; overflow-y: auto;"></div>
                    </div>

                    <div id="hiddenCheckboxes" style="display: none;">
                        <% allForums.forEach(f => { %>
                            <input type="checkbox" name="forumIds" value="<%= f.id %>" data-name="<%= f.title.toLowerCase() %>" id="check-<%= f.id %>">
                        <% }) %>
                    </div>
                </div>
                <!-- Hidden List of Tags -->
                <div id="tag-data" style="display:none;" data-forums="<%= JSON.stringify(allForums) %>"></div>

                <label>3. Description</label>
                <textarea name="content" rows="4" placeholder="Detailed description..." required></textarea>

                <label>4. Full Video Link (Any Site)</label>
                <input type="text" name="url" placeholder="Full Video Link" required>
                
                <label>5. Paste Image URLs (One per line)</label>
                <textarea id="urlInput" name="remoteUrls" rows="3" 
                    placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.png" 
                    style="font-size: 0.8rem; margin-bottom: 15px;"></textarea>

                <label for="post-images" class="file-label" id="main-file-label">üìé OR Image UPLOAD FROM DEVICE</label>
                <input type="file" id="post-images" name="images" multiple accept="image/*" style="display:none" onchange="updatePreviews()">

                <div id="image-preview-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 18px;"></div>
                
                <button type="submit" class="btn-accent">PUBLISH!</button>
            </form>
        </section>

    </div>
</div>

<script>
    function validateMedia() {
        const fileInput = document.getElementById('post-images');
        const urlInput = document.getElementById('urlInput');
        const checkboxes = document.querySelectorAll('input[name="forumIds"]:checked');
        
        // 1. Check Categories (New)
        if (checkboxes.length === 0) {
            alert("Please select at least one category/tag.");
            document.querySelector('.forum-selection-container').style.borderColor = "var(--accent)";
            return false;
        }

        // 2. Existing Image Validation
        const hasFiles = fileInput.files.length > 0;
        const hasUrls = urlInput.value.trim().length > 0;

        if (!hasFiles && !hasUrls) {
            alert("Please provide at least one image.");
            return false; 
        }

        return true; 
    }

    // Modal Logic
    const modal = document.getElementById('guideModal');
    const infoBtn = document.getElementById('infoBtn');
    const closeX = document.getElementById('closeGuide');
    const closeBtn = document.getElementById('closeGuideBtn');

    // Open
    infoBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    });

    // Close functions
    const closeModal = () => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Re-enable scrolling
    };

    [closeX, closeBtn].forEach(btn => btn.addEventListener('click', closeModal));

    // Close on outside click
    window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Hover effect for the ! button
    infoBtn.addEventListener('mouseover', () => infoBtn.style.borderColor = 'var(--accent)');
    infoBtn.addEventListener('mouseleave', () => infoBtn.style.borderColor = 'var(--border)');

    async function updatePreviews() {
        const container = document.getElementById('image-preview-container');
        const fileInput = document.getElementById('post-images');
        const urlInput = document.getElementById('urlInput');
        const label = document.getElementById('main-file-label');
        
        container.innerHTML = ""; // Clear existing
        urlInput.style.borderColor = "var(--border)";
        label.style.borderColor = "var(--border)";

        let totalCount = 0;
        const MAX_ALLOWED = 5;

        // 1. Process Files (Up to cap)
        Array.from(fileInput.files).forEach(file => {
            if (totalCount < MAX_ALLOWED) {
                const reader = new FileReader();
                reader.onload = (e) => addThumb(e.target.result);
                reader.readAsDataURL(file);
                totalCount++;
            }
        });

        // 2. Process URLs (If we haven't hit 5 yet)
        const urls = urlInput.value.split(/[\s\n,]+/).filter(u => u.trim().startsWith('http'));
        urls.forEach(url => {
            if (totalCount < MAX_ALLOWED) {
                addThumb(url);
                totalCount++;
            }
        });

        // 3. Update Label and UI feedback
        if (totalCount >= MAX_ALLOWED) {
            label.style.borderColor = "var(--accent)";
            label.innerText = "‚ö†Ô∏è LIMIT REACHED (MAX 5)";
        } else {
            label.style.borderColor = "var(--border)";
            label.innerText = fileInput.files.length > 0 ? `üìÇ ${fileInput.files.length} files selected` : "üìé OR UPLOAD FROM DEVICE";
        }

        function addThumb(src) {
            const div = document.createElement('div');
            div.style.aspectRatio = '1/1';
            div.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:4px; border: 1px solid var(--accent);">`;
            container.appendChild(div);
        }
    }
    
    // Attach listener to URL input as well
    document.getElementById('urlInput').addEventListener('input', updatePreviews);

</script>

<script>
    const tagDataEl = document.getElementById('tag-data');
    const allTags = JSON.parse(tagDataEl.getAttribute('data-forums') || '[]');
    const selectedTagIds = new Set();

    const titleInput = document.querySelector('input[name="title"]');
    const tagSearchInput = document.getElementById('tagSearchInput');
    const pillContainer = document.getElementById('pillContainer');
    const tagDropdown = document.getElementById('tagDropdown');
    const hiddenCheckboxes = document.getElementById('hiddenCheckboxes');

    function formatTagName(str) {
        return str.split('/').map(part => {
            let trimmedPart = part.trim();

            // 2. If this specific part is ALL CAPS (e.g., "DD" or "CFNM"), keep it
            if (trimmedPart === trimmedPart.toUpperCase() && trimmedPart.length > 0) {
                return trimmedPart;
            }

            // 3. Otherwise, fix "CheAting" -> "Cheating" and "double" -> "Double"
            return trimmedPart
                .toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }).join(' / '); // 4. Join back with spaces and the slash
    }

    // --- Add Tag Function ---
    function addTag(tag) {
        if (selectedTagIds.has(tag.id.toString())) return;
        
        selectedTagIds.add(tag.id.toString());
        
        // Find or create hidden checkbox
        let cb = document.getElementById(`check-${tag.id}`);
        if (!cb) {
             cb = document.createElement('input');
             cb.type = 'checkbox';
             cb.name = 'forumIds';
             cb.value = tag.id;
             cb.id = `check-${tag.id}`;
             hiddenCheckboxes.appendChild(cb);
        }
        cb.checked = true;

        const pill = document.createElement('div');
        pill.className = 'tag-pill';
        pill.innerHTML = `${tag.title} <span onclick="removeTag('${tag.id}', this)">&times;</span>`;
        pillContainer.appendChild(pill);
    }

    // --- Remove Tag Function ---
    window.removeTag = (id, el) => {
        selectedTagIds.delete(id.toString());
        const cb = document.getElementById(`check-${id}`);
        if (cb) cb.checked = false;
        el.parentElement.remove();
    };

    // --- FEATURE: Auto-check from Title ---
    titleInput.addEventListener('input', (e) => {
        const text = e.target.value.toLowerCase();
        if (text.length < 3) return; // Don't trigger for very short titles

        allTags.forEach(tag => {
            const tagName = tag.title.toLowerCase();
            // Only auto-add if it's a whole word to avoid accidental tags
            const regex = new RegExp(`\\b${tagName}\\b`, 'i');
            if (regex.test(text)) {
                addTag(tag);
            }
        });
    });

    // --- FEATURE: Search & Dropdown ---
    tagSearchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const searchVal = val.toLowerCase();
        const formattedVal = formatTagName(val);

        tagDropdown.innerHTML = '';
        
        if (val.length === 0) {
            tagDropdown.style.display = 'none';
            return;
        }

        const matches = allTags.filter(t => t.title.toLowerCase().includes(searchVal));
        
        matches.slice(0, 20).forEach(match => { // Limit to 20 results for speed
            const div = document.createElement('div');
            div.className = 'dropdown-item'; // Uses your CSS
            div.style = "padding: 10px; cursor: pointer; border-bottom: 1px solid #222; font-size: 0.8rem;";
            div.innerHTML = `${match.title} <small style="color: #555; float: right;">${match.header}</small>`;
            div.onclick = () => {
                addTag(match);
                tagSearchInput.value = '';
                tagDropdown.style.display = 'none';
            };
            tagDropdown.appendChild(div);
        });

        // "Create New" Logic
        if (!allTags.some(t => t.title.toLowerCase() === searchVal )) {
            const createOption = document.createElement('div');
            createOption.style = "padding: 10px; color: var(--accent); cursor: pointer; font-weight: bold; border-top: 1px solid #333;";
            createOption.innerHTML = `+ Create New: <span>"${formattedVal}"</span>`;
            createOption.onclick = () => handleInlineCreate(formattedVal);
            tagDropdown.appendChild(createOption);
        }

        tagDropdown.style.display = 'block';
    });

    // --- FEATURE: AJAX Create ---
    async function handleInlineCreate(tagName) {
        const formattedName = formatTagName(tagName);
        const originalText = tagSearchInput.value;
        tagSearchInput.value = "Creating...";
        
        try {
            const response = await fetch('/forum/create-api-tag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    title: formattedName, 
                    header: 'API',
                    bio: 'User created' 
                })
            });
            const newTag = await response.json();
            
            allTags.push(newTag);
            addTag(newTag);
            
            tagSearchInput.value = '';
            tagDropdown.style.display = 'none';
        } catch (err) {
            alert("Error creating tag");
            tagSearchInput.value = originalText;
        }
    }

    // Close dropdown on click outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-wrapper')) tagDropdown.style.display = 'none';
    });
</script>

</body>
</html>