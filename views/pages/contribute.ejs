<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribute | <%= siteTitle %></title>
    <link rel="icon" href="<%= favIcon %>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #F93742;
            --bg: #000;
            --surface: #111;
            --border: #222;
            --text-main: #FFF;
            --text-muted: #888;
            --input-bg: #080808;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; line-height: 1.5; }
        
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .page-header { margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .page-header h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
        .page-header p { color: var(--text-muted); }

        /* Grid Layout */
        .contribute-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; align-items: start; }

        @media (max-width: 900px) {
            .contribute-grid { grid-template-columns: 1fr; }
        }

        /* Common Form Styles */
        .card { background: var(--surface); border: 1px solid var(--border); padding: 30px; border-radius: 8px; }
        .card h3 { font-size: 0.75rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 20px; text-transform: uppercase; }
        
        label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }
        .container input, textarea, select { 
            width: 100%; background: var(--input-bg); border: 1px solid var(--border); 
            color: #fff; padding: 12px; margin-bottom: 18px; border-radius: 4px; font-family: inherit;
        }
        .container input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; }

        .btn-accent { 
            background: var(--accent); color: #fff; border: none; padding: 12px 30px; 
            font-weight: 700; border-radius: 4px; cursor: pointer; transition: 0.2s; width: 100%;
        }
        .btn-accent:hover { filter: brightness(1.2); }

        /* Multi-select Forum Container */
        .forum-selection-container {
            max-height: 250px; overflow-y: auto; background: var(--input-bg);
            padding: 15px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 18px;
        }
        .category-group-header {
            background: #1a1a1a; color: var(--accent); font-size: 0.65rem;
            font-weight: 800; padding: 4px 10px; margin: 10px 0 8px 0;
            border-left: 3px solid var(--accent); text-transform: uppercase;
        }
        .forum-item {
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem;
            cursor: pointer; padding: 5px; color: #ccc;
            transition: all 0.2s ease;
            background: #080808;
        }
        .forum-item:hover { 
            border-color: #444 !important;
            background: #111 !important; 
            color: #fff; }

        .forum-item:has(input:checked) {
            border-color: var(--accent) !important;
            background: rgba(249, 55, 66, 0.1) !important;
            color: var(--accent) !important;
        }
        
        .forum-item input[type="checkbox"] {
            display: none;
        }

        /* File Upload */
        .file-label { 
            display: inline-block; background: #222; padding: 10px 15px; border-radius: 4px; 
            font-size: 0.75rem; cursor: pointer; border: 1px solid var(--border); margin-bottom: 18px;
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .hidden-item {
            display: none !important;
        }

        /* Optional: Make the search input stand out slightly */
        #tagSearchInput {
            border-color: #333;
            background: #000;
        }
        #tagSearchInput:focus {
            border-color: var(--accent);
        }
    </style>
</head>
<body>

<%- include("../partials/navBar") %>

<div class="container">
    <header class="page-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h1>CONTRIBUTE</h1>
            <button id="infoBtn" style="background: var(--surface); border: 1px solid var(--border); color: var(--accent); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s;">!</button>
        </div>
        <p>Expand the community by sharing new content or creating new tags.</p>
    </header>

    <div id="guideModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px);">
        <div class="card" style="max-width: 700px; width: 100%; position: relative; border-color: var(--accent); box-shadow: 0 10px 40px rgba(0,0,0,0.5); padding: 0;">
            
            <div style="padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin-bottom: 0;">üöÄ Full Contribution Guide</h3>
                <button id="closeGuide" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>

            <div style="padding: 30px; max-height: 75vh; overflow-y: auto;">
                
                <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--accent); margin-bottom: 12px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">1. Sharing New Content</h4>
                    
                    <p style="font-size: 0.9rem; margin-bottom: 10px;"><strong style="color: #fff;">üè∑Ô∏è Titles & Tags:</strong></p>
                    <ul style="list-style: none; color: #ccc; font-size: 0.85rem; padding-left: 10px; border-left: 1px solid #333; margin-bottom: 15px;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Naming:</strong> Use <em>"Original Video Title (Performer Name)"</em>.</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Multi-Tagging:</strong> You can select multiple categories. Use the <strong>Search Bar</strong> inside the selection box to find specific tags instantly.</li>
                    </ul>

                    <p style="font-size: 0.9rem; margin-bottom: 10px;"><strong style="color: #fff;">üîó Video Links & Media:</strong></p>
                    <ul style="list-style: none; color: #ccc; font-size: 0.85rem; padding-left: 10px; border-left: 1px solid #333;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Video URL:</strong> Paste the full link to the source (e.g., YouTube, Vimeo, or other hosting sites). <strong>This is required.</strong></li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Previews:</strong> Maximum of 5 images. If using URLs, ensure they are direct links (ending in <code>.jpg</code>, <code>.png</code>).</li>
                    </ul>
                </div>

                <!-- <div style="margin-bottom: 30px;">
                    <h4 style="color: var(--accent); margin-bottom: 12px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">2. Creating New Tags</h4>
                    <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 10px;">If a performer or category doesn't exist yet:</p>
                    <ul style="list-style: none; color: #ccc; font-size: 0.85rem; padding-left: 10px; border-left: 1px solid #333;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Parent Header:</strong> You <u>must</u> select the correct parent group (e.g., placing a new performer under the "Performers" header).</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <strong>Bio:</strong> Keep it short‚Äîthis appears as a subtitle for the tag.</li>
                    </ul>
                </div> -->

                <!-- <div style="background: #0a0a0a; padding: 20px; border: 1px solid #222; border-radius: 4px;">
                    <h4 style="color: #fff; margin-bottom: 10px; font-size: 0.9rem;">üìù Best Practices</h4>
                    <ul style="list-style: none; color: #888; font-size: 0.8rem;">
                        <li style="margin-bottom: 5px;">‚Ä¢ Search before creating: Don't create "Lesbians" if "Lesbian" already exists.</li>
                        <li style="margin-bottom: 5px;">‚Ä¢ Check links: Ensure the video URL isn't broken before publishing.</li>
                        <li style="margin-bottom: 5px;">‚Ä¢ Quality: Use high-quality preview images to help your post get more views.</li>
                    </ul>
                </div> -->
            </div>

            <div style="padding: 20px 30px; border-top: 1px solid var(--border); background: var(--surface);">
                <button id="closeGuideBtn" class="btn-accent">I'VE READ THE RULES - LET'S GO</button>
            </div>
        </div>
    </div>

    <div class="contribute-grid">
        
        <section class="card">
            <h3>Create New Content</h3>
            <form action="/forum/posts/create" method="post" enctype="multipart/form-data" onsubmit="return validateMedia()">
                <label>Video Title</label>
                <input type="text" name="title" placeholder="Original Title with (Female Performer's name)" required>

                <label>Categorize Content</label>
                <div id="selectedTagsPreview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                </div>
                <div class="tag-search-wrapper" style="margin-bottom: 10px;">
                    <input type="text" id="tagSearchInput" placeholder="Quick find any tag..." style="font-size: 0.8rem; padding: 8px; margin-bottom: 0;">
                </div>

                <!-- <div class="forum-selection-container" style="max-height: 400px;"> -->
                    <% 
                        // 1. Define the headers you want to prioritize at the top
                        const headerOrder = ["Act", "Orientation", "No. of People", "Age", "Body","Ethnicity","Hair","Level","Locations","Profession","Relationship","Scenario","Actions","Toys"];

                        // 2. Group the forums by header
                        const grouped = {};
                        allForums.forEach(f => {
                            if (!grouped[f.header]) grouped[f.header] = [];
                            grouped[f.header].push(f);
                        });

                        // 3. Get all headers currently present in the data
                        const existingHeaders = Object.keys(grouped);

                        // 4. Create the final sequence: Priorities first, then the remaining "leftovers"
                        const finalHeaderSequence = [
                            ...headerOrder.filter(h => existingHeaders.includes(h)),
                            ...existingHeaders.filter(h => !headerOrder.includes(h))
                        ];
                    %>

                    <% finalHeaderSequence.forEach(header => { 
                        const forums = grouped[header]; 
                    %>
                        <div class="category-section" style="margin-bottom: 15px; border: 1px solid #222; border-radius: 4px; overflow: hidden;">
                            <div class="category-group-header" style="margin: 0; padding: 8px 10px; background: #1a1a1a; color: #fff; font-weight: bold; border-bottom: 1px solid #222;">
                                <%= header %>
                            </div>
                            <div class="category-options" style="padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; background: #111;">
                                <% forums.forEach(f => { %>
                                    <label class="forum-item" data-name="<%= f.title.toLowerCase() %>" style="border: 1px solid #222; padding: 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; color: #ccc; display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" name="forumIds" value="<%= f.id %>" style="margin: 0;">
                                        <%= f.title %>
                                    </label>
                                <% }) %>
                            </div>
                        </div>
                    <% }) %>
                <!-- </div> -->

                <label>Body Content</label>
                <textarea name="content" rows="4" placeholder="Detailed description..." required></textarea>

                <label>Full Video Link (Any Site)</label>
                <input type="text" name="url" placeholder="Full Video Link" required>
                
                <label>Or Paste Image URLs (One per line)</label>
                <textarea id="urlInput" name="remoteUrls" rows="3" 
                    placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.png" 
                    style="font-size: 0.8rem; margin-bottom: 15px;"></textarea>

                <label for="post-images" class="file-label" id="main-file-label">üìé OR UPLOAD FROM DEVICE</label>
                <input type="file" id="post-images" name="images" multiple accept="image/*" style="display:none" onchange="updatePreviews()">

                <div id="image-preview-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 18px;"></div>

                <button type="submit" class="btn-accent">PUBLISH!</button>
            </form>
        </section>

        <section class="card">
            <h3>Start a Category</h3>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px;">
                Couldn't find the tag, Create New tag!
            </p>
            <form action="/forum/create" method="post">
                <label>Category Title</label>
                <input type="text" name="title" placeholder="e.g. Lesbian / Straight" required>
                
                <label>Short Bio / Intro</label>
                <input type="text" name="bio" placeholder="Small intro for tag" required>
                
                <label>Parent Header</label>
                <select name="header" required>
                    <% forums.forEach(header => { %>
                        <option value="<%= header.name %>"><%= header.name %></option>
                    <% }) %>
                </select>

                <button type="submit" class="btn-accent" style="background: #333;">CREATE CATEGORY</button>
            </form>
        </section>

    </div>
</div>

<script>

    const forumCheckboxes = document.querySelectorAll('input[name="forumIds"]');
    const selectedPreview = document.getElementById('selectedTagsPreview');

    forumCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            updateSelectedChips();
        });
    });

    function updateSelectedChips() {
        selectedPreview.innerHTML = '';
        const selected = Array.from(forumCheckboxes).filter(cb => cb.checked);
        
        selected.forEach(cb => {
            const tagName = cb.parentElement.textContent.trim();
            const chip = document.createElement('span');
            chip.style.cssText = "background: var(--accent); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;";
            chip.innerHTML = `${tagName} <span style="font-size: 1rem;">&times;</span>`;
            
            // Clicking the chip unchecks the box
            chip.onclick = () => {
                cb.checked = false;
                updateSelectedChips();
            };
            selectedPreview.appendChild(chip);
        });
    }

    function validateMedia() {
        const fileInput = document.getElementById('post-images');
        const urlInput = document.getElementById('urlInput');
        const checkboxes = document.querySelectorAll('input[name="forumIds"]:checked');
        
        // 1. Check Categories (New)
        if (checkboxes.length === 0) {
            alert("Please select at least one category/tag.");
            document.querySelector('.forum-selection-container').style.borderColor = "var(--accent)";
            return false;
        }

        // 2. Existing Image Validation
        const hasFiles = fileInput.files.length > 0;
        const hasUrls = urlInput.value.trim().length > 0;

        if (!hasFiles && !hasUrls) {
            alert("Please provide at least one image.");
            return false; 
        }

        return true; 
    }


    // Modal Logic
    const modal = document.getElementById('guideModal');
    const infoBtn = document.getElementById('infoBtn');
    const closeX = document.getElementById('closeGuide');
    const closeBtn = document.getElementById('closeGuideBtn');

    // Open
    infoBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    });

    // Close functions
    const closeModal = () => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Re-enable scrolling
    };

    [closeX, closeBtn].forEach(btn => btn.addEventListener('click', closeModal));

    // Close on outside click
    window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Hover effect for the ! button
    infoBtn.addEventListener('mouseover', () => infoBtn.style.borderColor = 'var(--accent)');
    infoBtn.addEventListener('mouseleave', () => infoBtn.style.borderColor = 'var(--border)');
</script>

<script>
    async function updatePreviews() {
        const container = document.getElementById('image-preview-container');
        const fileInput = document.getElementById('post-images');
        const urlInput = document.getElementById('urlInput');
        const label = document.getElementById('main-file-label');
        
        container.innerHTML = ""; // Clear existing
        urlInput.style.borderColor = "var(--border)";
        label.style.borderColor = "var(--border)";

        let totalCount = 0;
        const MAX_ALLOWED = 5;

        // 1. Process Files (Up to cap)
        Array.from(fileInput.files).forEach(file => {
            if (totalCount < MAX_ALLOWED) {
                const reader = new FileReader();
                reader.onload = (e) => addThumb(e.target.result);
                reader.readAsDataURL(file);
                totalCount++;
            }
        });

        // 2. Process URLs (If we haven't hit 5 yet)
        const urls = urlInput.value.split(/[\s\n,]+/).filter(u => u.trim().startsWith('http'));
        urls.forEach(url => {
            if (totalCount < MAX_ALLOWED) {
                addThumb(url);
                totalCount++;
            }
        });

        // 3. Update Label and UI feedback
        if (totalCount >= MAX_ALLOWED) {
            label.style.borderColor = "var(--accent)";
            label.innerText = "‚ö†Ô∏è LIMIT REACHED (MAX 5)";
        } else {
            label.style.borderColor = "var(--border)";
            label.innerText = fileInput.files.length > 0 ? `üìÇ ${fileInput.files.length} files selected` : "üìé OR UPLOAD FROM DEVICE";
        }

        function addThumb(src) {
            const div = document.createElement('div');
            div.style.aspectRatio = '1/1';
            div.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:4px; border: 1px solid var(--accent);">`;
            container.appendChild(div);
        }
    }

    
    // Attach listener to URL input as well
    document.getElementById('urlInput').addEventListener('input', updatePreviews);

    document.getElementById('tagSearchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        const sections = document.querySelectorAll('.category-section');

        sections.forEach(section => {
            const items = section.querySelectorAll('.forum-item');
            let hasMatch = false;

            items.forEach(item => {
                const tagName = item.getAttribute('data-name') || "";
                if (tagName.includes(searchTerm)) {
                    item.style.display = 'flex';
                    hasMatch = true;
                } else {
                    item.style.display = 'none';
                }
            });

            // Hide the whole section (including header) if no items match
            section.style.display = hasMatch ? 'block' : 'none';
        });
    });
</script>

</body>
</html>