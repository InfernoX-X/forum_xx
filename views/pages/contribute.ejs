<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribute | <%= siteTitle %></title>
    <%- include("../partials/variables") %>

    <style>
        :root{
            --bg: var(--cx-bg);
            --surface: var(--cx-surface);
            --border: var(--cx-border);
            --text-main: var(--cx-text-main);
            --text-muted: var(--cx-text-muted);
            --input-bg: var(--cx-input-bg);
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-family); line-height: 1.5; }
        
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .page-header { display: flex; align-items: center;flex-direction: column; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .page-header h1 { font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; }
        .page-header p { color: var(--text-muted); }

        /* Grid Layout */
        .contribute-grid { display: flex; align-items: center; justify-content: center; gap: 40px; width: 100%; }

        
        .contribute-grid .card { background: var(--surface); border: 1px solid var(--border); padding: 30px; border-radius: 8px; width: 100%; max-width: 700px; }
        
        .guideBtn{
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .card { background: var(--surface); border: 1px solid var(--border); padding: 30px; border-radius: 8px; }
        .card h3 { font-size: 0.75rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 20px; text-transform: uppercase; }
        
        label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; font-weight: 700; }

        .container input, textarea, select { 
            width: 100%; background: var(--input-bg); border: 1px solid var(--border); 
            color: var(--white); padding: 12px; margin-bottom: 18px; border-radius: 4px; font-family: inherit;
        }
        .container input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; }

        .btn-accent { 
            background: var(--accent); color: var(--white); border: none; padding: 12px 30px; 
            font-weight: 700; border-radius: 4px; cursor: pointer; transition: 0.2s; width: 100%;
        }
        .btn-accent:hover { filter: brightness(1.2); }

        /* Multi-select Forum Container */
        .forum-selection-container {
            max-height: 250px; overflow-y: auto; background: var(--input-bg);
            padding: 15px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 18px;
        }
        .category-group-header {
            background: #1a1a1a; color: var(--accent); font-size: 0.65rem;
            font-weight: 800; padding: 4px 10px; margin: 10px 0 8px 0;
            border-left: 3px solid var(--accent); text-transform: uppercase;
        }
        .forum-item {
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem;
            cursor: pointer; padding: 5px; color: #ccc;
            transition: all 0.2s ease;
            background: #080808;
        }
        .forum-item:hover { 
            border-color: #444 !important;
            background: #111 !important; 
            color: var(--white); }

        .forum-item:has(input:checked) {
            border-color: var(--accent) !important;
            background: rgba(249, 55, 66, 0.1) !important;
            color: var(--accent) !important;
        }
        
        .forum-item input[type="checkbox"] {
            display: none;
        }

        /* File Upload */
        .file-label { 
            display: inline-block; background: #222; padding: 10px 15px; border-radius: 4px; 
            font-size: 0.75rem; cursor: pointer; border: 1px solid var(--border); margin-bottom: 18px;
        }
        
        .hidden-item {
            display: none !important;
        }
    </style>
    <style>
        /* Container for the search and pills */
        .tag-system {
            background: #111;
            border: 1px solid #222;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* The Pills */
        .tag-pill {
            --color: var(--accent);
            background: var(--color) !important;
            color: white !important;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none !important;
            cursor: pointer;
        }
    
        #pillContainer .channel {
            --color: rgb(51, 51, 51);
            background: var(--color) !important;
        }
        #pillContainer .no_of_people {
            --color: rgb(56, 89, 138);
            background: var(--color) !important;
        }
        #pillContainer .orientation {
            --color: rgb(91, 56, 124);
            background: var(--color) !important;
        }
        #pillContainer .level {
            --color: rgb(99, 32, 32);
            background: var(--color) !important;
        }
        #pillContainer .finishing {
            --color: rgb(33, 119, 55);
            background: var(--color) !important;
        }
        #pillContainer .sex_positions {
            --color: rgb(42, 53, 102);
            background: var(--color) !important;
        }
        #pillContainer .age {
            --color: rgb(124, 78, 52);
            background: var(--color) !important;
        }
        #pillContainer .emotions {
            --color: rgb(124, 56, 90);
            background: var(--color) !important;
        }
        #pillContainer .act {
            --color: rgb(101, 105, 43);
            background: var(--color) !important;
        }
        #pillContainer .ethnicity {
            --color: rgb(48, 124, 105);
            background: var(--color) !important;
        }

        #pillContainer .locations {
            --color: rgb(34, 110, 145); /* Deep Cyan/Blue */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .scenario {
            --color: rgb(150, 75, 0); /* Burnt Orange/Brown */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .fetish {
            --color: rgb(128, 0, 128); /* Deep Purple */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .actions {
            --color: rgb(165, 42, 42); /* Deep Red/Brown */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .relationship {
            --color: rgb(180, 50, 120); /* Deep Pink/Magenta */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .profession {
            --color: rgb(46, 139, 87); /* Sea Green */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .body_and_features {
            --color: rgb(107, 142, 35); /* Olive Drab */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .toys {
            --color: rgb(184, 134, 11); /* Dark Goldenrod */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .dress {
            --color: rgb(70, 130, 180); /* Steel Blue */
            background: var(--color) !important;
            color: #ffffff;
        }

        #pillContainer .other {
            --color: rgb(100, 100, 100); /* Mid-tone Grey */
            background: var(--color) !important;
            color: #ffffff;
        }

        .tag-pill span {
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
        }

        /* The Search Input */
        #tagSearchInput {
            background: var(--input-bg);
            border: 1px solid #333;
            color: var(--white);
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            outline: none;
        }

        #tagSearchInput:focus {
            border-color: var(--accent);
        }

        #tagDropdown {
            display: none; 
            position: absolute; 
            width: 100%; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            z-index: 999; /* Ensure it floats above other inputs */
            max-height: 250px; 
            overflow-y: auto;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .tag-pill small {
            text-transform: uppercase;
            margin-right: 5px;
            color: var(--accent);
        }




        /* Adjust Pill container for better visibility */
        #pillContainer {
            border-bottom: 1px solid #222;
            padding-bottom: 15px;
        }

         
        /* Container for the whole dropdown */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        /* The box the user clicks */
        .dropdown-trigger {
            background: #111;
            border: 1px solid #333;
            padding: 10px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #888;
            transition: border 0.2s;
        }

        .dropdown-trigger:hover { border-color: #555; }
        .custom-dropdown.active .dropdown-trigger { border-color: var(--accent); color: #fff; }

        /* The floating menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: #181818;
            border: 1px solid #333;
            z-index: 9999;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border-radius: 4px;
        }

        .custom-dropdown.active .dropdown-menu { display: block; }

        /* Individual items in the menu */
        .dropdown-item-label {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #222;
            font-size: 0.75rem;
            color: #eee;
            transition: background 0.2s;
        }

        .dropdown-item-label:hover { background: #252525; }
        .dropdown-item-label input {
            margin-right: 12px;
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .dropdown-trigger .arrow { font-size: 0.5rem; transition: transform 0.2s; }
        .custom-dropdown.active .arrow { transform: rotate(180deg); }

        .dropdown-search-wrapper input:focus {
            outline: none;
            border-color: var(--accent) !important;
        }

        .mandatory-groups{
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;
        }
        @media (max-width: 425px) {
            #mandatory-groups {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <style>
        
        /* Responsive Overrides */
        @media (max-width: 768px) {
            #guideModal > div {
                width: 95% !important;
                max-height: 90vh !important;
                display: flex;
                flex-direction: column;
            }

            #guideModal .grid-container {
                grid-template-columns: 1fr !important; /* Stack columns */
                overflow-y: auto !important;
                overflow-x: hidden;
            }

            #guideModal .left-panel {
                border-right: none !important;
                border-bottom: 1px solid var(--border);
            }
            
            #guideModal .footer-area {
                flex-direction: column;
                text-align: center;
                gap: 10px !important;
            }
        }

    </style>

</head>
<body>

<%- include("../partials/navBar") %>

<div class="container">
    <header class="page-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <h1>CONTRIBUTE!</h1>
        </div>
        <button class="guideBtn" id="infoBtn" style="background: rgba(249, 55, 66, 0.1); border: 1px solid var(--accent); color: var(--accent); padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: 800; font-size: 0.7rem; display: flex; align-items: center; gap: 8px; transition: 0.2s;">
            VIEW UPLOADING GUIDE <span style="font-size: 1rem;">!</span> 
        </button>
        <p>Expand the community by sharing new content or creating new tags.</p>
    </header>


    <div id="guideModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px);">
        <div class="card" style="max-width: 850px; width: 100%; position: relative; border-color: var(--accent); box-shadow: 0 20px 50px rgba(0,0,0,0.8); padding: 0; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;">
            
            <div style="padding: 15px 25px; background: #111; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h3 style="margin: 0; color: var(--white); font-size: 0.9rem; letter-spacing: 1px;">UPLOADING BLUEPRINT</h3>
                <button id="closeGuide" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>

            <div class="grid-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; overflow-y: auto;">
                
                <div class="left-panel" style="padding: 25px; background: #0a0a0a; border-right: 1px solid var(--border);">
                    <p style="font-size: 0.7rem; color: var(--accent); font-weight: 800; margin-bottom: 15px; text-transform: uppercase;">Correct Example:</p>
                    
                    <div style="pointer-events: none; opacity: 0.9;">
                        <label style="font-size: 0.6rem; color: #555;">1. NAME</label>
                        <div style="background: #151515; border: 1px solid #333; padding: 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 15px; color: #fff;">
                            What Happened Last Night (Zoe Parker)
                        </div>

                        <label style="font-size: 0.6rem; color: #555;">2. ADD TAGS</label>
                        <div style="display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap;">
                            <span style="background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">Straight</span>
                            <span style="background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">Family</span>
                            <span style="background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">Bedroom</span>
                            <span style="background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">Convinced</span>
                            <span style="background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">Pussy Licking</span>
                            <span style="background: var(--accent); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">Daughter's Friend</span>
                        </div>

                        
                        <label style="font-size: 0.6rem; color: #555;">3. DESCRIPTION</label>
                        <div style="background: #151515; border: 1px solid #333; padding: 8px; border-radius: 4px; font-size: 0.7rem; margin-bottom: 15px; color: #b1b1b1;">
                            After a sleepover begins, Marcus fondles a sleeping Zoe. Once she wakes, he convinces her to engage in sexual acts beside his daughter. Zoe complies but remains hesitant and overwhelmed.
                        </div>

                        <label style="font-size: 0.6rem; color: #555;">4. FULL VIDEO LINK (ANY SITE)</label>
                        <div style="background: #151515; border: 1px solid #333; padding: 8px; border-radius: 4px; font-size: 0.7rem; margin-bottom: 15px; color: #b1b1b1;">
                            https://mat6tube.com/watch/-123429083_456240958
                        </div>

                        <label style="font-size: 0.6rem; color: #555;">5. PASTE IMAGE URLS OR UPLOAD (MAX 5)</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div style="aspect-ratio: 1;"><img style="width: 100%; height: 100%; object-fit: cover;" src="https://i.ibb.co/Fk4sHXRf/763214-e9f7da1a5cb43a29f89467c93b2de583-post-single-big-1.jpg" alt=""></div>
                            <div style="aspect-ratio: 1;"><img style="width: 100%; height: 100%; object-fit: cover; object-position: right;" src="https://i.ibb.co/0R35kj5z/preview-800.webp" alt=""></div>
                        </div>
                    </div>
                </div>

                <div class="right-panel" style="padding: 20px 30px; background: #111;">
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--white); font-size: 0.9rem; margin-bottom: 5px;">1. The Title/Name Rule</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Video Name, Always include the <strong>Performer Name</strong> in parentheses at the end. This helps our search engine find content faster.</p>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--white); font-size: 0.9rem; margin-bottom: 5px;">2. Multiple Tags</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Don't settle for one! Use the search bar to find categories. If a tag doesn't exist, type it and click <strong>Create New</strong>.</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--white); font-size: 0.9rem; margin-bottom: 5px;">3. Description</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Provide context for the post. You can copy the <strong>original source description</strong> or write a brief summary in your own words.<p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: var(--white); font-size: 0.9rem; margin-bottom: 5px;">4. Full Video Link</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">Paste the URL to the <strong>full video</strong>. We support links from almost any hosting site‚Äîjust ensure the link is public and active.</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--white); font-size: 0.9rem; margin-bottom: 8px;">5. Image Previews</h4>
                        <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; margin-bottom: 10px;">
                            You can either <strong>paste the URL</strong> of an image directly or <strong>upload from storage</strong>. A maximum of 5 images can be added.
                        </p>
                        <div style="background: rgba(0,0,0,0.2); border-left: 3px solid var(--accent); padding: 10px 15px; border-radius: 4px;">
                            <p style="font-size: 0.75rem; color: var(--white); margin-bottom: 5px; font-weight: 600;">Quality Guidelines:</p>
                            <ul style="font-size: 0.7rem; color: #888; padding-left: 15px; margin: 0; line-height: 1.6;">
                                <li>‚úÖ <span style="color: #bbb;">Normal quality preferred</span> (720p/1080p).</li>
                                <li>‚ùå No ultra-high 4K RAW files (slows loading).</li>
                                <li>‚ùå No low-quality or pixelated thumbnails.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-area" style="padding: 15px 25px; border-top: 1px solid var(--border); background: #111; display: flex; gap: 15px; align-items: center; flex-shrink: 0;">
                <div style="flex-grow: 1; font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase;">
                    Ready to contribute?
                </div>
                <button id="closeGuideBtn" class="btn-accent" style="width: auto; padding: 10px 40px; font-size: 0.8rem;">GET STARTED</button>
            </div>
        </div>
    </div>

    <div class="contribute-grid">
        
        <section class="card">
            <h3>Create New Content</h3>
            <form action="/forum/posts/create" method="post" enctype="multipart/form-data" onsubmit="return validateMedia()">
                <label>1. Name</label>
                <input type="text" name="title" placeholder="Original Title with (Female Performer's name)" required>

                <label>2. Add Tags & Categories</label>
                    <div class="tag-system">
                        
                        <div id="mandatory-groups" class="mandatory-groups">
                        </div>

                        <label style="font-size: 0.6rem; opacity: 0.7;">Selected Tags Summary</label>
                        <div id="pillContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                        
                        <div class="search-wrapper" style="position: relative; max-width: 100%;">
                            <input type="text" id="tagSearchInput" placeholder="Search to add tags (e.g. Threesome, Squirt)..." autocomplete="off">
                            <div id="tagDropdown"></div>
                        </div>

                        <div id="hiddenCheckboxes" style="display: none;">
                        </div>

                    </div>

                <!-- Hidden List of Tags -->
                <div id="tag-data" style="display:none;" data-forums="<%= JSON.stringify(allForums) %>"></div>

                
                <label>3. Description</label>
                <textarea name="content" rows="4" placeholder="Detailed description..." required></textarea>

                <label>4. Full Video Link (Any Site)</label>
                <input type="text" name="url" placeholder="Full Video Link" required>
                
                <label>5. Paste Image URLs (One per line)</label>
                <textarea id="urlInput" name="remoteUrls" rows="3" 
                    placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.png" 
                    style="font-size: 0.8rem; margin-bottom: 15px;"></textarea>

                <label for="post-images" class="file-label" id="main-file-label">üìé OR Image UPLOAD FROM DEVICE</label>
                <input type="file" id="post-images" name="images" multiple accept="image/*" style="display:none" onchange="updatePreviews()">

                <div id="image-preview-container" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 18px;"></div>

                <% if (user && user.isAdmin == 1) { %>
                    <label>6. Save Draft</label>
                    <select name="draft" id="draft">
                        <option value="0" selected>No</option>
                        <option value="1">Yes (Not Showing)</option>
                    </select>
                <% } %>
                    
                <p style="font-size: 0.65rem; color: var(--text-muted); text-align: center; margin-bottom: 10px;">
                    By clicking publish, you agree to follow the 
                    <a href="javascript:void(0)" onclick="modal.style.display='flex'" style="color: var(--accent); text-decoration: none; font-weight: bold;">Uploading Guide</a>.
                </p>

                <button type="submit" class="btn-accent">PUBLISH!</button>
            </form>
        </section>

    </div>
    
</div>

<!-- Guide Modal -->
<script>
    function validateMedia() {
        const fileInput = document.getElementById('post-images');
        const urlInput = document.getElementById('urlInput');
        const checkboxes = document.querySelectorAll('input[name="forumIds"]:checked');
        
        // 1. Check Categories (New)
        if (checkboxes.length === 0) {
            alert("Please select at least one category/tag.");
            document.querySelector('.forum-selection-container').style.borderColor = "var(--accent)";
            return false;
        }

        // 2. Existing Image Validation
        const hasFiles = fileInput.files.length > 0;
        const hasUrls = urlInput.value.trim().length > 0;

        if (!hasFiles && !hasUrls) {
            alert("Please provide at least one image.");
            return false; 
        }

        return true; 
    }

    // Modal Logic
    const modal = document.getElementById('guideModal');
    const infoBtn = document.getElementById('infoBtn');
    const closeX = document.getElementById('closeGuide');
    const closeBtn = document.getElementById('closeGuideBtn');

    // Open
    infoBtn.addEventListener('click', () => {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    });

    // Close functions
    const closeModal = () => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Re-enable scrolling
    };

    [closeX, closeBtn].forEach(btn => btn.addEventListener('click', closeModal));

    // Close on outside click
    window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Hover effect for the ! button
    infoBtn.addEventListener('mouseover', () => infoBtn.style.borderColor = 'var(--accent)');
    infoBtn.addEventListener('mouseleave', () => infoBtn.style.borderColor = 'var(--border)');

    async function updatePreviews() {
        const container = document.getElementById('image-preview-container');
        const fileInput = document.getElementById('post-images');
        const urlInput = document.getElementById('urlInput');
        const label = document.getElementById('main-file-label');
        
        container.innerHTML = ""; // Clear existing
        urlInput.style.borderColor = "var(--border)";
        label.style.borderColor = "var(--border)";

        let totalCount = 0;
        const MAX_ALLOWED = 5;

        // 1. Process Files (Up to cap)
        Array.from(fileInput.files).forEach(file => {
            if (totalCount < MAX_ALLOWED) {
                const reader = new FileReader();
                reader.onload = (e) => addThumb(e.target.result);
                reader.readAsDataURL(file);
                totalCount++;
            }
        });

        // 2. Process URLs (If we haven't hit 5 yet)
        const urls = urlInput.value.split(/[\s\n,]+/).filter(u => u.trim().startsWith('http'));
        urls.forEach(url => {
            if (totalCount < MAX_ALLOWED) {
                addThumb(url);
                totalCount++;
            }
        });

        // 3. Update Label and UI feedback
        if (totalCount >= MAX_ALLOWED) {
            label.style.borderColor = "var(--accent)";
            label.innerText = "‚ö†Ô∏è LIMIT REACHED (MAX 5)";
        } else {
            label.style.borderColor = "var(--border)";
            label.innerText = fileInput.files.length > 0 ? `üìÇ ${fileInput.files.length} files selected` : "üìé OR UPLOAD FROM DEVICE";
        }

        function addThumb(src) {
            const div = document.createElement('div');
            div.style.aspectRatio = '1/1';
            div.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:4px; border: 1px solid var(--accent);">`;
            container.appendChild(div);
        }
    }
    
    // Attach listener to URL input as well
    document.getElementById('urlInput').addEventListener('input', updatePreviews);

    // --- AUTO-OPEN LOGIC ---
    window.addEventListener('load', () => {
        // Check if the user has seen the guide before using localStorage
        const hasSeenGuide = localStorage.getItem('hasSeenPostingBlueprint');

        if (!hasSeenGuide) {
            // Show the modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // Mark as seen when they click "Get Started"
            closeBtn.addEventListener('click', () => {
                localStorage.setItem('hasSeenPostingBlueprint', 'true');
            });
            
            // Also mark as seen if they just close the X
            closeX.addEventListener('click', () => {
                localStorage.setItem('hasSeenPostingBlueprint', 'true');
            });
        }
    });

</script>

<!-- Tags -->
<script>
    const tagDataEl = document.getElementById('tag-data');
    const allTags = JSON.parse(tagDataEl.getAttribute('data-forums') || '[]');
    const selectedTagIds = new Set();

    const titleInput = document.querySelector('input[name="title"]');
    const tagSearchInput = document.getElementById('tagSearchInput');
    const pillContainer = document.getElementById('pillContainer');
    const tagDropdown = document.getElementById('tagDropdown');
    const hiddenCheckboxes = document.getElementById('hiddenCheckboxes');

    const helper = (name) => {
        return name.replace(".", "").trim().replaceAll(" ", "_").toLowerCase();
    }

    // Define which headers MUST have a selection
    const MANDATORY_HEADERS = [ "channel", "no. of people", "orientation", "age","ethnicity","locations","act", "emotions","scenario", "fetish", "actions", "sex positions", "finishing" ,"relationship", "profession", "body and features", "toys", "dress", "other"];

    const mandatoryContainer = document.getElementById('mandatory-groups');


    function formatTagName(str) {
        return str.split('/').map(part => {
            let trimmedPart = part.trim();

            // 2. If this specific part is ALL CAPS (e.g., "DD" or "CFNM"), keep it
            if (trimmedPart === trimmedPart.toUpperCase() && trimmedPart.length > 0) {
                return trimmedPart;
            }

            // 3. Otherwise, fix "CheAting" -> "Cheating" and "double" -> "Double"
            return trimmedPart
                .toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }).join(' / '); // 4. Join back with spaces and the slash
    }

    // --- Add Tag Function ---
    function addTag(tag) {
        const idStr = tag.id.toString();

        if (selectedTagIds.has(idStr)) return;
        selectedTagIds.add(idStr);
        
        // 1. Hidden Form Input
        let cb = document.getElementById(`check-${idStr}`);
        if (!cb) {
            cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.name = 'forumIds';
            cb.value = tag.id;
            cb.id = `check-${idStr}`;
            hiddenCheckboxes.appendChild(cb);
        }
        cb.checked = true;

        // 2. Create Visible Pill
        const pill = document.createElement('div');
        pill.className = 'tag-pill';
        pill.classList.add(helper(tag.header));
        pill.dataset.id = idStr;
        pill.innerHTML = `
            ${tag.title} 
            <span onclick="removeTag('${tag.id}', this)">&times;</span>
        `;
        pillContainer.appendChild(pill);

        // 3. UI Sync: Check the dropdown box if it exists
        const dropdownCb = document.querySelector(`.dropdown-item-label input[data-id="${idStr}"]`);
        if (dropdownCb) {
            dropdownCb.checked = true;
            updateDropdownLabel(dropdownCb.closest('.custom-dropdown'));
        }
    }

    // Remove Tag (Pill + Uncheck Dropdown + Uncheck Hidden)
    window.removeTag = (id, el) => {
        const idStr = id.toString();
        selectedTagIds.delete(idStr);
        
        // Uncheck hidden submission input
        const cb = document.getElementById(`check-${idStr}`);
        if (cb) cb.checked = false;
        
        // Uncheck checkbox inside the dropdown menu
        const dropdownCb = document.querySelector(`.dropdown-item-label input[data-id="${idStr}"]`);
        if (dropdownCb) {
            dropdownCb.checked = false;
            updateDropdownLabel(dropdownCb.closest('.custom-dropdown'));
        }

        const pill = pillContainer.querySelector(`.tag-pill[data-id="${idStr}"]`);
        if (pill) pill.remove();
    };


    function updateDropdownLabel(container) {
        const count = container.querySelectorAll('input:checked').length;
        const label = container.querySelector('.selected-count');
        const headerLabel = container.querySelector('label').innerText.replace(' *', '');
        
        if (count > 0) {
            label.innerText = `${count} Selected`;
            label.style.color = "var(--accent)";
        } else {
            label.innerText = `Select ${headerLabel.toLowerCase()}...`;
            label.style.color = "#888";
        }
    }

    // --- FEATURE: Auto-check from Title ---
    titleInput.addEventListener('input', (e) => {
        const text = e.target.value.toLowerCase();
        if (text.length < 3) return; // Don't trigger for very short titles

        allTags.forEach(tag => {
            const tagName = tag.title.toLowerCase();
            const regex = new RegExp(`\\b${tagName}\\b`, 'i');
            if (regex.test(text)) {
                addTag(tag);
            }
        });
    });

    // 1. Modified setup function to include a search bar and unique IDs
    function setupMandatoryCategories() {
        mandatoryContainer.innerHTML = '';
        MANDATORY_HEADERS.forEach(headerName => {
            const groupTags = allTags.filter(t => t.header.toLowerCase() === headerName);
            if (groupTags.length === 0) return;

            const headerId = helper(headerName);
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-dropdown';
            wrapper.id = `dropdown-${headerId}`;
            
            wrapper.innerHTML = `
                <label style="margin-bottom:5px; color:var(--accent); display:block; font-size:0.65rem; text-transform:uppercase;">${headerName} *</label>
                <div class="dropdown-trigger" onclick="toggleDropdown(this)">
                    <span class="selected-count">Select ${headerName}...</span>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-search-wrapper" style="padding: 10px; position: sticky; top: 0; background: #111; z-index: 10;">
                        <input type="text" 
                            placeholder="Search ${headerName}..." 
                            style="width: 100%; padding: 5px; font-size: 0.8rem; background: #222; border: 1px solid #444; color: white;"
                            onkeyup="filterDropdown(this)">
                    </div>
                    <div class="items-container">
                        ${renderDropdownItems(groupTags)}
                    </div>
                </div>
            `;
            mandatoryContainer.appendChild(wrapper);
        });
    }

    // 2. New helper to render items (Sorted: Selected first, then Alphabetical)
    function renderDropdownItems(tags) {
        return tags
            .sort((a, b) => {
                const aSel = selectedTagIds.has(a.id.toString());
                const bSel = selectedTagIds.has(b.id.toString());
                if (aSel === bSel) return a.title.localeCompare(b.title);
                return aSel ? -1 : 1;
            })
            .map(tag => {
                const isChecked = selectedTagIds.has(tag.id.toString()) ? 'checked' : '';
                return `
                    <label class="dropdown-item-label" data-title="${tag.title.toLowerCase()}">
                        <input style="margin: 0;" type="checkbox" 
                            data-id="${tag.id}" 
                            data-title="${tag.title}" 
                            data-header="${tag.header}" 
                            ${isChecked}
                            onchange="syncSelection(this)">
                        <span style="margin-left: 10px;">${tag.title}</span>
                    </label>
                `;
            }).join('');
    }

    // 3. Search filter logic
    window.filterDropdown = (input) => {
        const filter = input.value.toLowerCase();
        const container = input.closest('.dropdown-menu').querySelector('.items-container');
        const labels = container.querySelectorAll('.dropdown-item-label');

        labels.forEach(label => {
            const text = label.getAttribute('data-title');
            label.style.display = text.includes(filter) ? "flex" : "none";
        });
    };


    // Opens/Closes the custom menus
    window.toggleDropdown = (el) => {
        const parent = el.parentElement;
        const wasOpen = parent.classList.contains('active');
        document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
        if (!wasOpen) parent.classList.add('active');
    };

    // When a checkbox in the dropdown is clicked
    window.syncSelection = (checkbox) => {
        const tag = { 
            id: checkbox.dataset.id, 
            title: checkbox.dataset.title, 
            header: checkbox.dataset.header 
        };
        
        // 1. Add or Remove the tag
        if (checkbox.checked) {
            addTag(tag);
        } else {
            removeTag(tag.id);
        }

        // 2. Locate the dropdown and the search input
        const dropdownWrapper = checkbox.closest('.custom-dropdown');
        const searchInput = dropdownWrapper.querySelector('.dropdown-search-wrapper input');
        const itemsContainer = dropdownWrapper.querySelector('.items-container');

        // 3. CLEAR the search text so user can type the next one immediately
        if (searchInput) {
            searchInput.value = '';
        }

        // 4. Re-render the items (this moves the selected one to the top and resets visibility)
        const headerName = tag.header.toLowerCase();
        const groupTags = allTags.filter(t => t.header.toLowerCase() === headerName);
        
        itemsContainer.innerHTML = renderDropdownItems(groupTags);
        updateDropdownLabel(dropdownWrapper);
    };


    // --- FEATURE: Search & Dropdown ---
    tagSearchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const searchVal = val.toLowerCase();
        const formattedVal = formatTagName(val);

        tagDropdown.innerHTML = '';
        
        if (val.length === 0) {
            tagDropdown.style.display = 'none';
            return;
        }

        const matches = allTags.filter(t => {
            const titleMatch = t.title.toLowerCase().includes(searchVal);
            const headerMatch = t.header.toLowerCase();
            
            const isMandatory = MANDATORY_HEADERS.includes(headerMatch);
            const isAlreadySelected = selectedTagIds.has(t.id.toString());
            
            // Only show if: Matches text AND (is NOT mandatory) AND (is NOT already picked)
            return titleMatch  && !isAlreadySelected;
        });

        matches.slice(0, 15).forEach(match => { // Limit to 15 results for speed
            const div = document.createElement('div');
            div.className = 'dropdown-item'; // Uses your CSS
            div.style = "padding: 10px; cursor: pointer; border-bottom: 1px solid #222; font-size: 0.8rem;";
            div.innerHTML = `${match.title} <small style="color: #555; float: right;">${match.header}</small>`;
            div.onclick = () => {
                addTag(match);
                tagSearchInput.value = '';
                tagDropdown.style.display = 'none';
            };
            tagDropdown.appendChild(div);
        });

        // "Create New" Logic
        if (!allTags.some(t => t.title.toLowerCase() === searchVal )) {
            const createOption = document.createElement('div');
            createOption.style = "padding: 10px; color: var(--accent); cursor: pointer; font-weight: bold; border-top: 1px solid #333;";
            createOption.innerHTML = `+ Create New: <span>"${formattedVal}"</span>`;
            createOption.onclick = () => handleInlineCreate(formattedVal);
            tagDropdown.appendChild(createOption);
        }

        tagDropdown.style.display = 'block';
    });

    // --- FEATURE: AJAX Create ---
    async function handleInlineCreate(tagName) {
        const formattedName = formatTagName(tagName);
        const originalText = tagSearchInput.value;
        tagSearchInput.value = "Creating...";
        
        try {
            const response = await fetch('/api/create-tag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    title: formattedName, 
                    header: 'API',
                    bio: 'User created' 
                })
            });
            const newTag = await response.json();
            
            allTags.push(newTag);
            addTag(newTag);
            
            tagSearchInput.value = '';
            tagDropdown.style.display = 'none';
        } catch (err) {
            alert("Error creating tag");
            tagSearchInput.value = originalText;
        }
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-dropdown')) {
            document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
        }
    });
    
    // Initialize on load
    setupMandatoryCategories();
</script>


</body>
</html>