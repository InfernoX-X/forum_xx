<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= siteTitle %> | <%= forumTitle %></title>
    <link rel="icon" href="<%= favIcon %>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<style>
    :root {
        --accent: #F93742;
        --bg: #000;
        --surface: #111;
        --border: #222;
        --text-main: #FFF;
        --text-muted: #888;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; line-height: 1.5; }

    .container { max-width: 1000px; margin: 60px auto; padding: 0 20px; }

    /* Header */
    #forum-title { font-size: 2.2rem; margin-bottom: 30px; font-weight: 800; border-left: 4px solid var(--accent); padding-left: 15px; }

    /* Composer & Edit Form */
    .post-composer { background: var(--surface); border: 1px solid var(--border); padding: 25px; border-radius: 8px; margin-bottom: 40px; }
    .post-composer h3 { font-size: 0.75rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 15px; text-transform: uppercase; }
    
    .post-composer input, .post-composer textarea { 
        width: 100%; background: #000; border: 1px solid var(--border); 
        color: #fff; padding: 12px; margin-bottom: 12px; border-radius: 4px; font-family: inherit;
    }
    
    .post-composer label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
    .post-composer input:focus, .post-composer textarea:focus { border-color: var(--accent); outline: none; }

    .btn-accent { background: var(--accent); color: #fff; border: none; padding: 10px 25px; font-weight: 700; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .btn-accent:hover { opacity: 0.9; }
    
    .btn-link { background: none; border: none; color: var(--text-muted); font-size: 0.75rem; font-weight: bold; cursor: pointer; text-transform: uppercase; }
    .btn-link:hover { color: #fff; text-decoration: underline; }

    /* Post Cards */
    .post-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 30px; padding: 25px; position: relative; }
    
    .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
    .post-author { color: var(--accent); font-weight: 700; font-size: 0.9rem; }
    .post-time { color: var(--text-muted); font-size: 0.8rem; }

    .delete-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; line-height: 1; margin-left: 10px; }
    .delete-btn:hover { color: var(--accent); }

    .post-display-title { font-size: 1.6rem; margin-bottom: 10px; font-weight: 700; }
    .post-display-text { color: #ccc; margin-bottom: 15px; font-size: 1rem; }
    .post-display-link { color: var(--accent); text-decoration: none; font-size: 0.85rem; display: block; margin-bottom: 15px; word-break: break-all; }

    /* Images */
    .popUpClass { width: 100%; cursor: pointer; margin-top: 15px; border-radius: 4px; overflow: hidden; }
    .post-display-image { width: 100%; max-height: 700px; object-fit: contain; background: #080808; display: block; border: 1px solid #222; }

    .file-input-wrapper { display: inline-block; margin-bottom: 10px; }
    .file-label { background: #222; padding: 8px 15px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); }


    /* Truncation Styles */
    .content-wrapper {
        position: relative;
        overflow: hidden;
        max-height: 4.5em; /* Approximately 3 lines of text */
        transition: max-height 0.3s ease-out;
    }

    .content-wrapper.expanded {
        max-height: 2000px; /* Large enough to fit any post */
    }

    .read-more-btn {
        display: block;
        color: var(--accent);
        background: none;
        border: none;
        font-size: 0.8rem;
        font-weight: 700;
        cursor: pointer;
        margin-top: 5px;
        padding: 0;
        text-transform: uppercase;
    }

    .read-more-btn:hover {
        text-decoration: underline;
    }

    /* Categories selection */
    .forum-selection-container {
        margin-bottom: 20px;
        background: #080808;
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: 4px;
    }
    .forum-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .forum-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .forum-item:hover { background: #1a1a1a; }
    .forum-item input[type="checkbox"] { width: auto; margin: 0; accent-color: var(--accent); }

    /* Badge styles for displaying multiple forums on a post */
    .forum-badge-container { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
    .forum-badge { 
        background: #222; 
        color: var(--accent); 
        font-size: 0.7rem; 
        padding: 2px 8px; 
        border-radius: 10px; 
        border: 1px solid var(--accent);
        font-weight: 600;
    }
</style>

<body>
<%- include("../partials/navBar") %>

<div class="container">
    <h1 id="forum-title"><%= forumTitle %></h1>

    <div class="post-composer">
        <form action="/forum/posts/create" method="post" enctype="multipart/form-data">
            <h3>CREATE A NEW POST</h3>
            <input type="text" name="title" placeholder="POST TITLE (REQUIRED)" required>

            <label>Select Forums/Categories (Pick one or more)</label>
            <div class="forum-selection-container">
                <div class="forum-grid">
                    <% allForums.forEach(f => { %>
                        <label class="forum-item">
                            <input type="checkbox" name="forumIds" value="<%= f.id %>" <%= f.id == forum_id ? 'checked' : '' %>>
                            <%= f.title %>
                        </label>
                    <% }) %>
                </div>
            </div>

            <input type="text" name="content" placeholder="SUMMARY/BODY">
            <input type="text" name="url" placeholder="VIDEO URL">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="file-input-wrapper">
                    <label for="post-image" class="file-label" id="main-file-label">ðŸ“Ž UPLOAD IMAGE</label>
                    <input type="file" id="post-image" name="image" accept="image/*" required style="display:none" onchange="document.getElementById('main-file-label').innerText = 'ðŸ“‚ ' + this.files[0].name">
                </div>
                <button type="submit" class="btn-accent">POST</button>
            </div>
        </form>
    </div>

    <hr style="border: 0; border-top: 1px solid #222; margin: 40px 0;">

    <div id="posts-feed">
        <% for (const post of posts) { %>
            <div class="post-card" id="post-<%= post.id %>">
                
                <div class="post-header">
                    <div>
                        <span class="post-author"><%= post.username %></span> 
                        <span class="post-time">â€¢ <%= timeAgo(post.created_at) %></span>
                    </div>

                    <% if (user && user.id === post.user_id) { %>
                        <div style="display: flex; align-items: center;">
                            <button class="btn-link" onclick="toggleEdit('<%= post.id %>')">Edit</button>
                            
                            <form action="/forum/posts/delete/<%= post.id %>" method="POST" style="display:inline;">
                                <input type="hidden" name="forum_id" value="<%= post.forum_id %>">
                                <button id="deleteBtn-<%= post.id %>" type="submit" class="delete-btn" onclick="return confirm('Delete this post?')">&times;</button>
                            </form>
                        </div>
                    <% } %>
                </div>

                <div id="view-mode-<%= post.id %>">
                    <div class="forum-badge-container">
                        <% if (post.categories) { %>
                            <% post.categories.split(',').forEach(cat => { %>
                                <span class="forum-badge"><%= cat %></span>
                            <% }) %>
                        <% } %>
                    </div>
                    <h2 class="post-display-title"><%= post.title %></h2>
                    <div class="post-display-text">
                        <div id="content-<%= post.id %>" class="content-wrapper">
                            <%= post.content %>
                        </div>
                        <% if (post.content && post.content.length > 150) { %>
                            <button id="btn-<%= post.id %>" class="read-more-btn" onclick="toggleReadMore('<%= post.id %>')">
                                Read More
                            </button>
                        <% } %>
                    </div>

                    <% if (post.url) { %>
                        <a href="<%= post.url %>" class="post-display-link" target="_blank">ðŸ”— <%= post.url %></a>
                    <% } %>

                    <div class="popUpClass">
                        <img src="<%= post.image %>" class="post-display-image" alt="Post Image">
                    </div>
                </div>

                <% if (user && user.id === post.user_id) { %>
                    <div id="edit-mode-<%= post.id %>" style="display: none;">
                        <form action="/forum/posts/edit/<%= post.id %>" method="POST" enctype="multipart/form-data" class="post-composer" style="margin-bottom: 0; padding: 0; border: none; background: none;">
                            
                            <label>Update Forums/Categories</label>
                            <div class="forum-selection-container">
                                <div class="forum-grid">
                                    <% allForums.forEach(f => { %>
                                        <label class="forum-item">
                                            <input type="checkbox" name="forumIds" value="<%= f.id %>" 
                                            <%= post.forum_ids && post.forum_ids.split(',').includes(f.id.toString()) ? 'checked' : '' %>>
                                            <%= f.title %>
                                        </label>
                                    <% }) %>
                                </div>
                            </div>

                            <label>Title</label>
                            <input type="text" name="title" value="<%= post.title %>" required>
                            
                            <label>Summary</label>
                            <textarea name="content" rows="4"><%= post.content %></textarea>
                            
                            <label>Link (URL)</label>
                            <input type="text" name="url" value="<%= post.url %>">
                            
                            <label>Change Image (Optional)</label>
                            <input type="file" name="image" accept="image/*" style="background: #222; padding: 5px;">
                            
                            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 10px;">
                                <button type="button" class="btn-link" onclick="toggleEdit('<%= post.id %>')">Cancel</button>
                                <button type="submit" class="btn-accent">Save Changes</button>
                            </div>
                        </form>
                    </div>
                <% } %>

            </div>
        <% } %>
    </div>
</div>

<%- include("../partials/imageViewer") %>

<script>
    
    function toggleReadMore(postId) {
        const contentDiv = document.getElementById(`content-${postId}`);
        const btn = document.getElementById(`btn-${postId}`);

        if (contentDiv.classList.contains('expanded')) {
            contentDiv.classList.remove('expanded');
            btn.innerText = "Read More";
        } else {
            contentDiv.classList.add('expanded');
            btn.innerText = "Read Less";
        }
    }

    function toggleEdit(postId) {
        const viewDiv = document.getElementById(`view-mode-${postId}`);
        const editDiv = document.getElementById(`edit-mode-${postId}`);
        const delBtn = document.getElementById(`deleteBtn-${postId}`);

        if (viewDiv.style.display === "none") {
            delBtn.style.display = "block";
            viewDiv.style.display = "block";
            editDiv.style.display = "none";
        } else {
            delBtn.style.display = "none";
            viewDiv.style.display = "none";
            editDiv.style.display = "block";
        }
    }

    // Init gallery
    if (typeof initializeImageGallery === "function") {
        initializeImageGallery("popUpClass");
    }
</script>

</body>
</html>