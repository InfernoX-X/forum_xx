<!-- Popup Image Viewer (CSS) -->
<style>
    /* POPUP VIEWER STYLES */
.popup-image {
    position: fixed;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.95);
    height: 100vh;
    width: 100%;
    z-index: 10000000;
    display: none;
    backdrop-filter: blur(5px);
    transition: opacity 0.3s;
}

.popup-image_hide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.image-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
}

.popup-image-content {
    position: absolute; 
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%) scale(1);

    width: auto;
    height: auto;
    max-width: 90%;
    max-height: 90%;

    cursor: zoom-in; /* Default state */
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    user-select: none;
    touch-action: none; /* Prevents default browser panning behavior */
    border-radius: 8px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.popup-image-content.zoomed {
    cursor: grab;
}

.popup-image-content.zoomed.dragging {
    cursor: grabbing;
}

.close-btn {
    position: absolute;
    top: 16px;
    right: 24px;
    cursor: pointer;
    z-index: 1010;
    color: var(--accent-clr);
    transition: color 0.2s;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
    padding: 10px;
}
.close-btn:hover {
    color: #fff;
}
.close-btn svg {
    width: 40px;
    height: 40px;
    display: block;
}

/* Navigation buttons (arrows) */
.nav-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: white;
    background: rgba(0, 0, 0, 0.5);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    z-index: 1005;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.nav-arrow:hover {
    background: rgba(0, 0, 0, 0.8);
}

.nav-arrow svg {
    width: 32px;
    height: 32px;
}

#prev-btn { left: 16px; }
#next-btn { right: 16px; }

/* Zoom Status Indicator */
#zoom-status {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 16px;
    background-color: rgba(31, 41, 55, 0.8);
    color: white;
    font-size: 0.875rem;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
}


/* Media Queries for Responsiveness */
@media (max-width: 640px) {
    .gallery-header h1 {
        font-size: 1.8rem;
    }
    .nav-arrow {
        padding: 6px 12px;
    }
    .nav-arrow svg {
        width: 24px;
        height: 24px;
    }
    #prev-btn { left: 8px; }
    #next-btn { right: 8px; }
    .close-btn {
        top: 8px;
        right: 8px;
    }
    .close-btn svg {
        width: 30px;
        height: 30px;
    }
}
</style>

<!-- Popup Image Viewer (HTML) -->
<div class="popup-image" id="popup-viewer">
      <span class="close-btn" id="close-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 10.586l4.95-4.95a1.5 1.5 0 112.122 2.121L14.121 12l4.95 4.95a1.5 1.5 0 01-2.121 2.122L12 14.121l-4.95 4.95a1.5 1.5 0 01-2.122-2.121L9.879 12 4.93 7.05a1.5 1.5 0 012.122-2.121L12 10.586z"/>
          </svg>
      </span>
      
      <span id="prev-btn" class="nav-arrow">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
          </svg>
      </span>
      <span id="next-btn" class="nav-arrow">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
          </svg>
      </span>

      <div class="popup-image_hide" id="popup-image-hide"></div>

      <div class="image-container">
          <img src="" alt="Popup Image" id="popup-img" class="popup-image-content">
          
          <div id="zoom-status">
              Click to Zoom (Current: 1x)
          </div>
      </div>
  </div>

<!-- Popup Image Viewer (JS) -->
<script>
    const initializeImageGallery = (
    selector = "popUpClass",
    popupViewerId = "popup-viewer",
    popupImgId = "popup-img",
    closeBtnId = "close-btn",
    hideDivId = "popup-image-hide",
    prevBtnId = "prev-btn",
    nextBtnId = "next-btn",
    zoomStatusId = "zoom-status"
) => {
    const popupViewer = document.getElementById(popupViewerId);
    const popupImg = document.getElementById(popupImgId);
    const closeBtn = document.getElementById(closeBtnId);
    const hideDiv = document.getElementById(hideDivId);
    const prevBtn = document.getElementById(prevBtnId);
    const nextBtn = document.getElementById(nextBtnId);
    const zoomStatus = document.getElementById(zoomStatusId);
    const feedContainer = document.getElementById('posts-feed');

    if (!popupViewer || !popupImg || !feedContainer) return;

    let allImages = [];
    let currentIndex = -1;
    let scale = 1, translateX = 0, translateY = 0;
    let isDragging = false, startX = 0, startY = 0, dragMove = 0;
    const maxScale = 3;

    const updateImageList = () => {
        const images = feedContainer.querySelectorAll(`.${selector} img`);
        allImages = Array.from(images).map(img => img.src);
    };

    const applyTransform = () => {
        // translate(-50%, -50%) keeps it centered
        // translateX/Y handles the user panning
        popupImg.style.transform = `translate(calc(-50% + ${translateX}px), calc(-50% + ${translateY}px)) scale(${scale})`;
        
        if (zoomStatus) {
            zoomStatus.textContent = `Click to Zoom (Current: ${scale}x)`;
            zoomStatus.style.opacity = scale > 1 ? "1" : "0";
        }
    };

    const resetZoom = () => {
        scale = 1; translateX = 0; translateY = 0;
        isDragging = false;
        dragMove = 0;
        popupImg.classList.remove('zoomed', 'dragging');
        popupImg.style.cursor = 'zoom-in';
        applyTransform();
    };

    const showImage = (index) => {
        if (index < 0 || index >= allImages.length) return;
        currentIndex = index;
        popupViewer.style.display = 'block';
        popupImg.src = allImages[currentIndex];
        document.body.style.overflow = 'hidden';
        resetZoom();

        prevBtn.style.visibility = (currentIndex === 0) ? 'hidden' : 'visible';
        nextBtn.style.visibility = (currentIndex === allImages.length - 1) ? 'hidden' : 'visible';
    };

    // --- EVENT DELEGATION ---
    feedContainer.addEventListener('click', (e) => {
        const targetThumbnail = e.target.closest(`.${selector}`);
        if (targetThumbnail) {
            e.preventDefault();
            updateImageList();
            const clickedImg = targetThumbnail.querySelector('img');
            if (clickedImg) {
                const index = allImages.indexOf(clickedImg.src);
                showImage(index);
            }
        }
    });

    const closePopup = () => {
        popupViewer.style.display = 'none';
        document.body.style.overflow = 'auto';
        resetZoom();
    };

    closeBtn.addEventListener('click', closePopup);
    hideDiv.addEventListener('click', closePopup);

    // Navigation
    prevBtn.addEventListener('click', (e) => { e.stopPropagation(); if (currentIndex > 0) showImage(currentIndex - 1); });
    nextBtn.addEventListener('click', (e) => { e.stopPropagation(); if (currentIndex < allImages.length - 1) showImage(currentIndex + 1); });

    // --- PANNING LOGIC ---
    const startDrag = (e) => {
        if (scale > 1) {
            // Ensure it's left click (button 0) or a touch event
            if (e.type === 'mousedown' && e.button !== 0) return;
            
            isDragging = true;
            dragMove = 0; // Crucial: Reset movement on every new press
            popupImg.classList.add('dragging');

            const coords = e.touches ? e.touches[0] : e;
            startX = coords.clientX - translateX;
            startY = coords.clientY - translateY;
            
            // Prevent text selection while dragging
            e.preventDefault();
        }
    };

    const doDrag = (e) => {
        if (!isDragging) return;

        const coords = e.touches ? e.touches[0] : e;
        translateX = coords.clientX - startX;
        translateY = coords.clientY - startY;
        
        dragMove++; // Increment movement counter
        applyTransform();
    };

    const stopDrag = () => {
        isDragging = false;
        popupImg.classList.remove('dragging');
    };

    // Listeners for Panning
    popupImg.addEventListener('mousedown', startDrag);
    popupImg.addEventListener('touchstart', startDrag, { passive: false });

    // Use window so panning continues even if mouse leaves the image
    window.addEventListener('mousemove', doDrag);
    window.addEventListener('touchmove', doDrag, { passive: false });
    window.addEventListener('mouseup', stopDrag);
    window.addEventListener('touchend', stopDrag);
    window.addEventListener('blur', stopDrag);

    // --- ZOOM TOGGLE ---
    popupImg.addEventListener('click', (e) => {
        // If dragMove is high, the user was panning, not clicking to zoom
        if (dragMove > 5) {
            dragMove = 0;
            return;
        }

        if (scale === 1) {
            scale = maxScale;
            popupImg.classList.add('zoomed');
            popupImg.style.cursor = 'grab';
        } else {
            resetZoom();
        }
        applyTransform();
        dragMove = 0;
    });

    // Keyboard
    document.addEventListener('keydown', (e) => {
        if (popupViewer.style.display === 'block') {
            if (e.key === 'Escape') closePopup();
            if (e.key === 'ArrowLeft' && currentIndex > 0) showImage(currentIndex - 1);
            if (e.key === 'ArrowRight' && currentIndex < allImages.length - 1) showImage(currentIndex + 1);
        }
    });
};
</script>
