<!-- Nav CSS -->
<style>
    .main-navbar {
        height: 70px;
        width: 100%;
        background-color: var(--nav-bg);
        border-bottom: 1px solid #222;
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        font-family: 'Inter', system-ui, sans-serif;
    }

    .nav-container {
        width: 100%;
        padding: 0 20px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 2fr 1fr; /* Equal parts for perfect centering */
        align-items: center;
    }

    .logo {
        text-decoration: none;
        color: var(--white);
        font-size: 1.5rem;
        font-weight: 800;
        white-space: nowrap;
    }

    .logo span { color: var(--accent); }

    .search-container {
        display: flex;
        justify-content: center;
        padding: 0 15px;
    }

    .search-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px;
    }

    .search-wrapper input {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        padding: 10px 15px 10px 40px;
        border-radius: 14px;
        color: var(--white);
        outline: none;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        margin-left: 5px;
    }

    .search-wrapper input:focus {
        border-color: var(--accent);
        background: var(--border-color);
        box-shadow: 0 0 0 4px rgba(249, 55, 66, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-dim);
        pointer-events: none;
    }

    /* Navigation Controls */
    .nav-controls {
        display: flex;
        justify-content: flex-end;
    }

    .dropdown { position: relative; }

    .dropbtn {
        background: #222;
        color: var(--white);
        border: 1px solid var(--accent);
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dropdown-content {
        display: none; 
        position: absolute;
        right: 0;
        top: calc(100% + 15px);
        background-color: var(--dropdown-bg);
        min-width: 280px;
        box-shadow: 0px 12px 24px rgba(0,0,0,0.6);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .dropdown-content.active { display: block; animation: fadeIn 0.2s ease-out; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-content button {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        color: #eee;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        border: none;
        background: none;
        cursor: pointer;
        transition: background 0.2s ease;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .dropdown-content button:hover {
        background-color: rgba(255, 255, 255, 0.04);
    }

    .btn-label {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-label span:first-child {
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 18px;
        background-color: #333;
        border-radius: 20px;
        transition: all 0.3s;
    }

    /* The slider circle */
    .switch::after {
        content: "";
        position: absolute;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background-color: #888;
        top: 2px;
        left: 2px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Active State Styles */
    .status-on .switch {
        background-color: rgba(249, 55, 66, 0.2);
    }

    .status-on .switch::after {
        background-color: var(--accent);
        transform: translateX(16px);
    }

    /* Specific fix for the Categories link */
    .nav-link-btn {
        text-decoration: none;
        color: inherit;
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
    }

    .chevron {
        color: #444;
        font-weight: 800;
        font-size: 1rem;
    }

    .dropdown-content button a.action-link {
        width: 100%;
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        color: inherit;
        font-weight: inherit;
    }
    
    /* Modernizing the Status Labels (ON/OFF) */
    .dropdown-content button small {
        font-weight: 800;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3);
        text-transform: uppercase;
    }

    /* Logout Specific styling for a cleaner look */
    .logout-btn {
        margin-top: 4px;
        padding: 14px 16px !important;
        color: var(--accent) !important;
        font-weight: 700 !important;
        opacity: 0.9;
    }

    .logout-btn:hover {
        background-color: rgba(249, 55, 66, 0.1) !important;
        opacity: 1;
    }

    /* Ensure icons have consistent width so text stays aligned */
    .dropdown-content button span:first-child {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .dropdown-content button a {
        color: #ccc;
        cursor: pointer;
        text-decoration: none;
    }

    .nav-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-right: 15px;
    }

    .action-btn {
        background: var(--accent);
        color: var(--white);
        text-decoration: none;
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: transform 0.2s;
    }

    .action-btn:hover { transform: translateY(-1px); opacity: 0.9; }

    /* Settings Button - simplified to an icon */
    .dropbtn-icon {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--white);
        width: 38px;
        height: 38px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Dropdown specific cleanup */
    .user-info { position: relative; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
    .user-info small { color: var(--text-dim); display: block; font-size: 0.65rem; }

    .dropdown-section-title {
        padding: 12px 16px 4px;
        font-size: 0.65rem;
        font-weight: 800;
        color: #555;
        text-transform: uppercase;
    }

    .dropdown-divider { border: 0; border-top: 1px solid var(--border-color); margin: 4px 0; }
    .logout-btn { color: var(--accent) !important; font-weight: 600; }

    /* Responsive */
    @media (max-width: 600px) {
        .nav-actions .label { display: none; }
        .nav-actions { gap: 15px; }
    }

    @media (max-width: 768px) {
        .nav-container {
            grid-template-columns: auto 1fr auto;
        }
        .search-wrapper input {
            padding: 10px;
            padding-left: 35px;
        }
        .dropbtn span { display: none; } /* Icon only on mobile */
    }

    @media (max-width: 480px) {
        .search-container { padding: 0 5px; }
        .logo { font-size: 1.1rem; }
    }
    
    /* Help Icon Styling */
    .badge-help {
        position: relative;
        cursor: help;
        display: inline-flex;
    }

    .help-icon {
        font-size: 0.8rem;
        color: var(--text-dim);
        background: #333;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .badge-help:hover .help-icon {
        color: white;
    }

    /* Tooltip Table Styling */
    .badge-tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        left: 50%;
        transform: translateX(-50%) translateY(0);
        top: 55px; 
        background: #1a1a1a;
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 10px;
        width: 220px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        z-index: 1100;
        transition: all 0.2s ease-out;
        pointer-events: none;
    }

    /* 3. The Trigger Logic: Hovering the icon shows the box */
    .user-info:has(.badge-help:hover) .badge-tooltip {
        visibility: visible;
        opacity: 1;
        transform: translateX(-50%) translateY(8px);
    }
    
    .badge-help:hover .badge-tooltip {
        visibility: visible;
        opacity: 1;
        transform: translateX(-65%) translateY(10px);
    }

    .badge-tooltip::after {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #1a1a1a;
    }

    .tooltip-title {
        font-size: 0.7rem;
        font-weight: 800;
        color: var(--accent);
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .badge-tooltip table {
        width: 100%;
        border-collapse: collapse;
    }

    .badge-tooltip td {
        font-size: 0.75rem;
        padding: 4px 0;
        color: #eee;
    }

    .badge-tooltip td:last-child {
        text-align: right;
        color: var(--text-dim);
        font-weight: 700;
    }

    .tooltip-footer {
        border-top: 1px solid var(--border-color);
        margin-top: 8px;
        padding-top: 8px;
        font-size: 0.6rem;
        color: #555;
        font-style: italic;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .progress-bar-bg {
        width: 100%;
        height: 6px;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #444;
    }

    .progress-bar-fill {
        height: 100%;
        width: var(--p, 0%); 
        background-size: 200% auto;
        
        background: linear-gradient(90deg, var(--accent), #ff8e3c, #fde047);
        box-shadow: 0 0 12px rgba(249, 55, 66, 0.3);
        transition: width 0.5s ease;
    }


    .pulse-indicator {
        width: 8px;
        height: 8px;
        background: #4ade80; /* Success Green */
        border-radius: 50%;
        display: inline-block;
        margin-right: 2px;
        position: relative;
    }

    .pulse-indicator::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        border-radius: inherit;
        animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
    }

    @keyframes pulse-ring {
        0% { transform: scale(.7); opacity: 0.8; }
        80%, 100% { transform: scale(2.5); opacity: 0; }
    }

    /* Image Hiding and Edit Mode Hiding */
    body.hide-images img, 
    body.hide-images .popUpClass, 
    body.hide-images .post-content img {
        display: none !important;
    }

    /* Optional: Keep the logo visible while hiding other images */
    body.hide-images .logo img {
        display: block !important;
    }

    .hide-editBtn {
        transition: opacity 0.3s ease;
    }

    body.hide-edit-active .hide-editBtn {
        display: none !important;
    }
</style>

<!-- User Badges -->
<style>
    .badge {
        font-size: 0.65rem;
        padding: 3px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: 800;
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
    }

    .badge-noob { background: #2a2a2a; color: #888; border: 1px solid #444; }

    .badge-contributor { background: #1e3a2f; color: #4ade80; border: 1px solid #14532d; } 

    .badge-regular { background: #1e293b; color: #38bdf8; border: 1px solid #1e40af; } 

    .badge-elder {
        background: #4a2d0f;
        color: #fb923c;
        border: 1px solid #7c2d12;
        box-shadow: 0 0 5px rgba(124, 45, 18, 0.3);
    }

    .badge-elite { 
        background: linear-gradient(135deg, #f93742 0%, #991b1b 100%); 
        color: white; 
    }

    .badge-expert { 
        background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); 
        color: white;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
    }

    .badge-legend { 
        background: linear-gradient(135deg, #f59e0b 0%, #78350f 100%); 
        color: var(--white);
        border: 1px solid #fde047;
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        animation: pulse 2s infinite;
    }

    .badge-god {
        background: linear-gradient(135deg, #111 0%, #F93742 50%, #111 100%);
        background-size: 200% auto;
        color: var(--white);
        border: 1px solid #f93742;
        box-shadow: 0 0 15px rgba(249, 55, 66, 0.6);
        animation: godFlare 3s linear infinite;
        text-shadow: 0 0 5px #000;
    }

    @keyframes godFlare {
        0% { background-position: 0% center; }
        50% { background-position: 100% center; }
        100% { background-position: 0% center; }
    }

</style>

<!-- Password Change Popup Modal -->
<style>
    .fx-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .fx-modal-overlay.active { display: flex; }

    .fx-modal-content {
        background: var(--dropdown-bg);
        width: 90%;
        max-width: 400px;
        padding: 24px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        animation: fxModalIn 0.3s ease-out;
    }

    @keyframes fxModalIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .fx-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .fx-modal-header h3 { color: var(--white); margin: 0; font-size: 1.1rem; }

    .fx-close-modal {
        background: none;
        border: none;
        color: var(--text-dim);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .fx-input-group { margin-bottom: 15px; }

    .fx-input-group label {
        display: block;
        color: var(--text-dim);
        font-size: 0.75rem;
        font-weight: 700;
        margin-bottom: 6px;
        text-transform: uppercase;
    }

    .fx-input-group input {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 8px;
        color: var(--white);
        outline: none;
    }

    .fx-input-group input:focus { border-color: var(--accent); }

    .fx-save-btn {
        width: 100%;
        background: var(--accent);
        color: var(--white);
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    /* Loading State */
    .fx-save-btn:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
        transform: none;
        opacity: 0.8;
    }

    .fx-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--white);
        animation: fx-spin 0.8s linear infinite;
    }

    @keyframes fx-spin {
        to { transform: rotate(360deg); }
    }
    /* Toast Notification Styling */
    .fx-toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .fx-toast {
        background: #1e1e1e;
        color: var(--white);
        padding: 12px 20px;
        border-radius: 10px;
        border-left: 4px solid var(--accent);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        animation: fx-toast-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        min-width: 250px;
    }

    .fx-toast.success { border-left-color: #4ade80; }
    .fx-toast.error { border-left-color: #F93742; }

    @keyframes fx-toast-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .fx-toast-fade-out {
        animation: fx-toast-out 0.4s forwards;
    }

    @keyframes fx-toast-out {
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<nav class="main-navbar">
    <div class="nav-container">
        <a href="/" class="logo">Forum<span>X</span></a>

        <div class="search-container">
            <form action="/search" method="GET" class="search-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" name="q" placeholder="Lookup..." autocomplete="off">
            </form>
        </div>

        <div class="nav-controls">
            <div class="nav-actions">
                <a href="/contribute" class="action-btn" title="New Content">
                    <span>+</span><span class="label">Add Content</span>
                </a>
            </div>
            
            <div class="dropdown">
                <button class="dropbtn-icon" id="settingsBtn">‚öôÔ∏è</button>
                
                <% 
                    // 1. MASTER CONFIG (Sorted high to low)
                    const ranks = [
                        { min: 2000, label: 'God', class: 'god', icon: 'üê¶‚Äçüî•' },
                        { min: 1000, label: 'Legend', class: 'legend', icon: 'üëë' },
                        { min: 500,  label: 'Expert', class: 'expert', icon: 'üíé' },
                        { min: 250,  label: 'Elite', class: 'elite', icon: 'üî•' },
                        { min: 100,  label: 'Elder', class: 'elder', icon: 'üî∂' },
                        { min: 50,   label: 'Regular', class: 'regular', icon: 'üõ°Ô∏è' },
                        { min: 10,   label: 'Member', class: 'contributor', icon: 'üìú' },
                        { min: 0,    label: 'Novice', class: 'noob', icon: 'üå±' }
                    ];

                    // 2. FIND CURRENT RANK
                    let currentRank = ranks.find(r => user.postCount >= r.min);

                    // 3. FIND NEXT RANK
                    let nextRankIndex = ranks.findIndex(r => user.postCount >= r.min) - 1;
                    let nextRank = nextRankIndex >= 0 ? ranks[nextRankIndex] : null;

                    // 4. CALCULATE BRACKET PROGRESS
                    let progress = 100;
                    if (nextRank) {
                        let currentLevelMin = currentRank.min;
                        let nextLevelMin = nextRank.min;
                        progress = ((user.postCount - currentLevelMin) / (nextLevelMin - currentLevelMin)) * 100;
                    }
                %>

                <div class="dropdown-content" id="settingsDropdown">
                    <div class="user-info">
                        <small>SIGNED IN AS</small>
                        <div style="display: flex; align-items: center; gap: 10px; position: relative;">
                            <div class="pulse-indicator" title="Live Session Active"></div>
                            <strong style="letter-spacing: 1px;"><%= user.username %></strong>
                            
                            <span class="badge badge-<%= currentRank.class %>">
                                <%= currentRank.icon %> <%= currentRank.label %>
                            </span>

                            <div class="badge-help">
                                <span class="help-icon">‚ìò</span>
                            </div>
                        </div>

                        <div class="badge-tooltip">
                            <div class="tooltip-title">System Hierarchy</div>
                            <table>
                                <% [...ranks].reverse().forEach(rank => { %>
                                    <tr class="<%= user.postCount >= rank.min ? 'rank-unlocked' : 'rank-locked' %>">
                                        <td><%= rank.icon %> <%= rank.label %></td>
                                        <td><%= rank.min %>+</td>
                                    </tr>
                                <% }); %>
                            </table>
                            
                            <div class="tooltip-footer">
                                <% if (nextRank) { %>
                                    EST. UPLINK: <strong><%= nextRank.label %></strong> IN <%= nextRank.min - user.postCount %> UNITS
                                <% } else { %>
                                    <span class="glitch-text">MAX LEVEL REACHED</span>
                                <% } %>
                            </div>
                        </div>

                        <div class="user-progress-container" style="padding: 10px 0; margin-top: 6px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: #888; margin-bottom: 6px; text-transform: uppercase; font-weight: 900;">
                                <span>Next Phase: <%= nextRank ? nextRank.label : 'N/A' %></span>
                                <span><%= Math.floor(progress) %>%</span>
                            </div>

                            <div class="progress-bar-bg" style="height: 6px; background: #111; border-radius: 0;">
                                <div class="progress-bar-fill" style="--p:<%= progress %>%; height: 100%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); width: var(--p); "></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dropdown-section-title">Extra Navigation</div>
                    
                    <button onclick="window.location.href='/categories'">
                        <div class="btn-label">
                            <span>üè∑Ô∏è</span>
                            <span>Categories</span>
                        </div>
                        <span class="chevron">‚Ä∫</span>
                    </button>
                    
                    <div class="dropdown-section-title">Interface</div>
                    
                    <button id="imageToggle" class="status-on">
                        <div class="btn-label">
                            <span>üñºÔ∏è</span>
                            <span>Images Visible</span>
                        </div>
                        <div class="switch"></div>
                    </button>
                    
                    <button id="editModeToggle" class="status-on">
                        <div class="btn-label">
                            <span>‚úèÔ∏è</span>
                            <span>Edit Mode</span>
                        </div>
                        <div class="switch"></div>
                    </button>
                    
                    <div class="dropdown-section-title">Security</div>
                    
                    <button id="openPassModal">
                        <div class="btn-label">
                            <span>üîë</span>
                            <span>Change Password</span>
                        </div>
                        <span class="chevron">‚Ä∫</span>
                    </button>

                    <hr class="dropdown-divider">
                    
                    <button onclick="confirm('Logout?') ? window.location.href='/logout' : ''" class="logout-btn">
                        <span>üí® Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</nav>  

<div id="passwordModal" class="fx-modal-overlay">
    <div class="fx-modal-content">
        <div class="fx-modal-header">
            <h3>Update Security</h3>
            <button class="fx-close-modal">&times;</button>
        </div>
        <form id="passwordForm" action="/update-password" method="POST">
            <div class="fx-input-group">
                <label>Current Password</label>
                <input type="password" name="currentPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="fx-input-group">
                <label>New Password</label>
                <input type="password" name="newPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="fx-input-group">
                <label>Repeat New Password</label>
                <input type="password" name="confirmPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="fx-save-btn">Update Password</button>
        </form>
    </div>
</div>

<div id="toastContainer" class="fx-toast-container"></div>

<!-- Nav JS -->
<script>

    document.addEventListener('DOMContentLoaded', () => {
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const passModal = document.getElementById('passwordModal');
        const openPassBtn = document.getElementById('openPassModal');
        const closePassBtn = document.querySelector('.fx-close-modal');
        const passwordForm = document.getElementById('passwordForm');
        const body = document.body;

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (settingsDropdown.classList.contains('active')) {
                if (!settingsDropdown.contains(e.target) && e.target !== settingsBtn) {
                    settingsDropdown.classList.remove('active');
                }
            }
        });

        openPassBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            settingsDropdown.classList.remove('active'); 
            passModal.classList.add('active');
        });

        closePassBtn.addEventListener('click', () => {
            passModal.classList.remove('active');
        });

        // passModal.addEventListener('click', (e) => {
        //     if (e.target === passModal) {
        //         passModal.classList.remove('active');
        //     }
        // });

        // --- TOGGLE LOGIC (Images) ---
        const imageBtn = document.getElementById('imageToggle');
        const updateImages = (hide) => {
            body.classList.toggle('hide-images', hide);
            imageBtn.classList.toggle('status-on', !hide);
        };

        imageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const hide = !body.classList.contains('hide-images');
            localStorage.setItem('hideForumImages', hide);
            updateImages(hide);
        });

        // --- TOGGLE LOGIC (Edit Mode) ---
        const editModeBtn = document.getElementById('editModeToggle');
        const updateEditMode = (hide) => {
            body.classList.toggle('hide-edit-active', hide);
            editModeBtn.classList.toggle('status-on', !hide);
        };

        editModeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isNowHidden = body.classList.contains('hide-edit-active');
            const nextState = !isNowHidden;
            localStorage.setItem('hideEditBtn', nextState);
            updateEditMode(nextState);
        });

        passwordForm.addEventListener('submit', (e) => {
            const submitBtn = passwordForm.querySelector('.fx-save-btn');
            const newPass = passwordForm.elements['newPassword'].value;
            const confirmPass = passwordForm.elements['confirmPassword'].value;

            // 1. Validate
            if (newPass !== confirmPass) {
                e.preventDefault();
                alert("New passwords do not match!");
                return;
            }

            // 2. Loading State
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="fx-spinner"></div> Updating...`;
        });

        // --- TOAST NOTIFICATION SYSTEM ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `fx-toast ${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('fx-toast-fade-out');
                setTimeout(() => toast.remove(), 400);
            }, 4000);
        };

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('status')) {
            const status = urlParams.get('status');
            if (status === 'updated') showToast('Security updated successfully!', 'success');
            if (status === 'error') showToast('Failed to update security.', 'error');
            
            // Clean up the URL so the toast doesn't reappear on manual refresh
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- INITIALIZE STATES ---
        updateImages(localStorage.getItem('hideForumImages') === 'true');
        updateEditMode(localStorage.getItem('hideEditBtn') === 'true');
    });

    
</script>
