<!-- Nav CSS -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Fontdiner+Swanky&display=swap');

    .main-navbar {
        height: 70px;
        width: 100%;
        background-color: var(--nav-bg);
        border-bottom: 1px solid #222;
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        font-family: 'Inter', system-ui, sans-serif;
    }

    .nav-container {
        width: 100%;
        padding: 0 20px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 2fr 1fr; /* Equal parts for perfect centering */
        align-items: center;
    }

    .logo {
        text-decoration: none;
        color: var(--white);
        font-size: 1.5rem;
        font-weight: 800;
        white-space: nowrap;
    }

    .logo span { color: var(--accent); }

    .search-container {
        display: flex;
        justify-content: center;
        padding: 0 15px;
        width: 100%;
        align-items: center;
    }

    .search-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto; /* Added this to force center within the grid cell */
    }

    .search-wrapper input {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        padding: 10px 15px 10px 40px;
        border-radius: 14px;
        color: var(--white);
        outline: none;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        margin-left: 5px;
    }

    .search-wrapper input:focus {
        border-color: var(--accent);
        background: var(--border-color);
        box-shadow: 0 0 0 4px rgba(249, 55, 66, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-dim);
        pointer-events: auto; /* CHANGE THIS FROM 'none' TO 'auto' */
        cursor: pointer;      /* Add this so user knows it's clickable */
        z-index: 101;
    }

    /* Navigation Controls */
    .nav-controls {
        display: flex;
        justify-content: flex-end;
    }

    .dropdown { position: relative; }

    .dropbtn {
        background: #222;
        color: var(--white);
        border: 1px solid var(--accent);
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dropdown-content {
        display: none; 
        position: absolute;
        right: 0;
        top: calc(100% + 15px);
        background-color: var(--dropdown-bg);
        min-width: 340px;
        box-shadow: 0px 12px 24px rgba(0,0,0,0.6);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .dropdown-content.active { display: block; animation: fadeIn 0.2s ease-out; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-content button {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        color: #eee;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        border: none;
        background: none;
        cursor: pointer;
        transition: background 0.2s ease;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .dropdown-content button:hover {
        background-color: rgba(255, 255, 255, 0.04);
    }

    .btn-label {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-label span:first-child {
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 18px;
        background-color: #333;
        border-radius: 20px;
        transition: all 0.3s;
    }

    /* The slider circle */
    .switch::after {
        content: "";
        position: absolute;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background-color: #888;
        top: 2px;
        left: 2px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Active State Styles */
    .status-on .switch {
        background-color: rgba(249, 55, 66, 0.2);
    }

    .status-on .switch::after {
        background-color: var(--accent);
        transform: translateX(16px);
    }

    /* Specific fix for the Categories link */
    .nav-link-btn {
        text-decoration: none;
        color: inherit;
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
    }

    .chevron {
        color: #444;
        font-weight: 800;
        font-size: 1rem;
    }

    .dropdown-content button a.action-link {
        width: 100%;
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        color: inherit;
        font-weight: inherit;
    }
    
    /* Modernizing the Status Labels (ON/OFF) */
    .dropdown-content button small {
        font-weight: 800;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.3);
        text-transform: uppercase;
    }

    /* Logout Specific styling for a cleaner look */
    .logout-btn {
        margin-top: 4px;
        padding: 14px 16px !important;
        color: var(--accent) !important;
        font-weight: 700 !important;
        opacity: 0.9;
    }

    .logout-btn:hover {
        background-color: rgba(249, 55, 66, 0.1) !important;
        opacity: 1;
    }

    /* Ensure icons have consistent width so text stays aligned */
    .dropdown-content button span:first-child {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .dropdown-content button a {
        color: #ccc;
        cursor: pointer;
        text-decoration: none;
    }

    .nav-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-right: 15px;
    }

    .action-btn {
        background: var(--accent);
        color: var(--white);
        text-decoration: none;
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: transform 0.2s;
    }

    .action-btn:hover { transform: translateY(-1px); opacity: 0.9; }

    /* Settings Button - simplified to an icon */
    .dropbtn-icon {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--white);
        width: 38px;
        height: 38px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Dropdown specific cleanup */
    .user-info { position: relative; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
    .user-info small { color: var(--text-dim); display: block; font-size: 0.75rem; }

    .dropdown-section-title {
        padding: 12px 16px 4px;
        font-size: 0.65rem;
        font-weight: 800;
        color: #555;
        text-transform: uppercase;
    }

    .dropdown-divider { border: 0; border-top: 1px solid var(--border-color); margin: 4px 0; }
    .logout-btn { color: var(--accent) !important; font-weight: 600; }
    
    /* Mobile Search Logic */
    @media (max-width: 425px) {
        .action-btn .label{
            display: none;
        }

    }

    @media (max-width: 375px) {

        /* .action-btn .label{
            display: none;
        } */

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        body.search-open .logo, 
        body.search-open .nav-actions,
        body.search-open #settingsBtn {
            display: none !important;
        }

        /* Expand search container to fill the space */
        body.search-open .search-container {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            padding: 0 10px;
            z-index: 1000;
            background: var(--nav-bg); 
            display: flex;
            align-items: center;
        }

        .search-container {
            width: auto;
        }

        body.search-open .search-wrapper {
            max-width: 100%;
            width: 100%;
        }

        /* Initial State: Hide the input text area, show only icon area */
        .search-wrapper input {
            width: 40px;
            background: transparent;
            border: none;
            color: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Active State: Show the input and background */
        body.search-open .search-wrapper input {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--accent);
            padding: 10px 45px; /* Space for icon on left and X on right */
            color: var(--white);
            cursor: text;
            border-radius: 12px;
        }

        /* Move the magnifying glass to stay visible */
        .search-icon {
            cursor: pointer;
            /* left: 10px; */
            z-index: 11;
        }
    }

    /* Help Icon Styling */
    .badge-help {
        position: relative;
        cursor: help;
        display: inline-flex;
        opacity: 0.4;
        margin-left: 14px;
    }

    .help-icon {
        font-size: 0.8rem;
        color: var(--text-dim);
        background: #333;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .badge-help:hover .help-icon {
        color: white;
    }

    /* Tooltip Table Styling */
    .badge-tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        left: 50%;
        transform: translateX(-50%) translateY(0);
        top: 55px; 
        background: #1a1a1a;
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 10px;
        width: 220px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        z-index: 1100;
        transition: all 0.2s ease-out;
        pointer-events: none;
    }

    /* 3. The Trigger Logic: Hovering the icon shows the box */
    .user-info:has(.badge-help:hover) .badge-tooltip {
        visibility: visible;
        opacity: 1;
        transform: translateX(-50%) translateY(8px);
    }
    
    .badge-help:hover .badge-tooltip {
        visibility: visible;
        opacity: 1;
        transform: translateX(-65%) translateY(10px);
    }

    .badge-tooltip::after {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #1a1a1a;
    }

    .tooltip-title {
        font-size: 0.7rem;
        font-weight: 800;
        color: var(--accent);
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .badge-tooltip table {
        width: 100%;
        border-collapse: collapse;
    }

    .badge-tooltip td {
        font-size: 0.75rem;
        padding: 4px 0;
        color: #eee;
    }

    .badge-tooltip td:last-child {
        text-align: right;
        color: var(--text-dim);
        font-weight: 700;
    }

    .tooltip-footer {
        border-top: 1px solid var(--border-color);
        margin-top: 8px;
        padding-top: 8px;
        font-size: 0.6rem;
        color: #555;
        font-style: italic;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .progress-bar-bg {
        width: 100%;
        height: 6px;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #444;
    }

    .progress-bar-fill {
        height: 100%;
        width: var(--p, 0%); 
        background-size: 200% auto;
        
        background: linear-gradient(90deg, var(--accent), #ff8e3c, #fde047);
        box-shadow: 0 0 12px rgba(249, 55, 66, 0.3);
        transition: width 0.5s ease;

        position: relative;
        overflow: hidden;
    }

    .progress-bar-fill::after {
        content: "";
        position: absolute;
        top: 0; left: 0; bottom: 0; right: 0;
        background: linear-gradient(
            90deg, 
            rgba(255,255,255,0) 0%, 
            rgba(255,255,255,0.5) 50%, 
            rgba(255,255,255,0) 100%
        );
        animation: progress-shine 2s infinite;
        z-index: 1;
    }

    @keyframes progress-shine {
        from { transform: translateX(-100%); }
        to { transform: translateX(100%); }
    }


    .pulse-indicator {
        width: 8px;
        height: 8px;
        background: #4ade80; /* Success Green */
        border-radius: 50%;
        display: inline-block;
        margin-right: 2px;
        position: relative;
    }

    .pulse-indicator::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: inherit;
        border-radius: inherit;
        animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
    }

    @keyframes pulse-ring {
        0% { transform: scale(.7); opacity: 0.8; }
        80%, 100% { transform: scale(2.5); opacity: 0; }
    }

    /* Image Hiding and Edit Mode Hiding */
    body.hide-images img, 
    body.hide-images .popUpClass, 
    body.hide-images .post-content img {
        display: none !important;
    }

    /* Optional: Keep the logo visible while hiding other images */
    body.hide-images .logo img {
        display: block !important;
    }

    .hide-editBtn {
        transition: opacity 0.3s ease;
    }

    body.hide-edit-active .hide-editBtn {
        display: none !important;
    }
</style>

<!-- Notifications -->
<style>
    /* Container & Dropdown Behavior */
    .fx-noti-wrapper {
        position: relative;
        display: inline-block;
    }
    
    .fx-noti-dropdown {
        display: none; 
        position: absolute;
        top: calc(100% + 15px);
        right: 0;
        min-width: 340px;
        background: var(--dropdown-bg);
        border: 1px solid rgba(0,0,0,0.6);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border-radius: 8px;
        overflow: hidden;
    }

    .fx-noti-dropdown.show {
        display: block !important;
    }

    /* Header Section */
    .fx-noti-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #111111;
        border-bottom: 1px solid #080808;
        font-size: 0.9rem;
        font-weight: bold;
    }

    .fx-noti-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    /* List Items */
    .fx-noti-scroll-area {
        max-height: 400px;
        overflow-y: auto;
    }

    .fx-noti-item {
        position: relative;
        padding: 12px 15px;
        border-bottom: 1px solid #111;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
        gap: 10px 4px;
    }

    .fx-noti-item:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .fx-noti-unread {
        background: rgba(var(--accent-rgb), 0.05); /* Uses accent color tint */
        border-left: 3px solid var(--accent);
    }

    .fx-noti-item p {
        margin: 0;
        font-size: 0.85rem;
        line-height: 1.4;
        color: var(--text-main);
    }

    .fx-noti-unread p {
        font-weight: bold;
        color: #fff;
    }

    .fx-noti-item small {
        font-size: 0.7rem;
        color: var(--text-dim);
    }

    .fx-noti-link-btn {
        background: none;
        border: none;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        color: #2ea1ff;
        opacity: 0.8;
        transition: 0.2s;
        padding: 0;
        font-family: inherit; 
        letter-spacing: 1px;

    }

    .fx-noti-clear-btn {
        background: none;
        border: none;
        color: #ff3939;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        transition: 0.2s;
    }
    .fx-noti-link-btn:hover, .fx-noti-clear-btn:hover {
        opacity: 1;
        text-decoration: underline;
    }
    
    .fx-noti-delete {
        display: none;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 0, 0, 0.1);
        color: #ff4d4d;
        border: none;
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 1rem;
        cursor: pointer;
    }

    .fx-noti-item:hover .fx-noti-delete {
        display: block;
    }

    .fx-noti-loading {
        padding: 20px;
        text-align: center;
        color: var(--text-dim);
        font-size: 0.8rem;
    }

    .svg_bell{
        padding: 6px;
    }

    #notiDot {
        display: none; 
        position: absolute; 
        top: -5px; 
        right: -5px; 
        min-width: 20px;
        height: 20px; 
        font-size: 0.8rem;
        background: var(--accent); 
        color: white; 
        border-radius: 10px; 
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        box-shadow: 0 0 10px var(--accent);
        pointer-events: none; 
    }

    .fx-noti-content-row {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .fx-noti-icon {
        font-size: 1.1rem;
        margin-top: 2px;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
    }

    .fx-noti-text-wrapper {
        flex: 1; /* Takes up remaining space */
        padding-right: 20px; /* Leave room for the delete button */
    }

    /* Optional: Make the icon pulse slightly for unread items */
    .fx-noti-unread .fx-noti-icon {
        animation: fx-pulse 2s infinite;
    }

    @keyframes fx-pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
</style>

<!-- Popup Modal -->
<style>
    .fx-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .fx-modal-overlay.active { display: flex; }

    .fx-modal-content {
        background: var(--dropdown-bg);
        width: 90%;
        max-width: 400px;
        padding: 24px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        animation: fxModalIn 0.3s ease-out;
    }

    @keyframes fxModalIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .fx-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .fx-modal-header h3 { color: var(--white); margin: 0; font-size: 1.1rem; }

    .fx-close-modal {
        background: none;
        border: none;
        color: var(--text-dim);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .fx-input-group { margin-bottom: 15px; }

    .fx-input-group label {
        display: block;
        color: var(--text-dim);
        font-size: 0.75rem;
        font-weight: 700;
        margin-bottom: 6px;
        text-transform: uppercase;
    }

    .fx-input-group input {
        width: 100%;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 8px;
        color: var(--white);
        outline: none;
    }

    .fx-input-group input:focus { border-color: var(--accent); }

    .fx-save-btn {
        width: 100%;
        background: var(--accent);
        color: var(--white);
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    /* Loading State */
    .fx-save-btn:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
        transform: none;
        opacity: 0.8;
    }

    .fx-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--white);
        animation: fx-spin 0.8s linear infinite;
    }

    @keyframes fx-spin {
        to { transform: rotate(360deg); }
    }
    /* Toast Notification Styling */
    .fx-toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .fx-toast {
        background: #1e1e1e;
        color: var(--white);
        padding: 12px 20px;
        border-radius: 10px;
        border-left: 4px solid var(--accent);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        animation: fx-toast-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        min-width: 250px;
    }

    .fx-toast.success { border-left-color: #4ade80; }
    .fx-toast.error { border-left-color: #F93742; }

    @keyframes fx-toast-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .fx-toast-fade-out {
        animation: fx-toast-out 0.4s forwards;
    }

    @keyframes fx-toast-out {
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<!-- Fontdiner Swanky -->
<!-- Badge CSS -->
<style>
.badge {
    position: relative;
    padding: 8px 24px;
    font-size: 0.8rem;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 12px;
    color: #fff;
    background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
    border-radius: 2px;
    box-shadow: 
        inset 0 1px 1px rgba(255,255,255,0.3), 
        0 5px 15px rgba(0,0,0,0.8),
        0 0 0 1px #333;

    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    font-family: "Fontdiner Swanky" !important;
    letter-spacing: 5px;
    font-style: normal;
    overflow: hidden;
    margin-left: 10px;
    margin-right: 5px;
    cursor: default;
}

.badge::before {
    content: '';
    position: absolute;
    top: 0; left: -150%;
    width: 100%; height: 100%;
    background: linear-gradient(
        90deg, 
        transparent, 
        rgba(255, 255, 255, 0.2) 50%, 
        transparent
    );
    transform: skewX(-20deg);
    /* animation: metal-shimmer 6s infinite; */
}

@keyframes metal-shimmer {
    0% { left: -150%; }
    20% { left: 150%; }
    100% { left: 150%; }
}

@keyframes flow-blood {
    from { background-position: 200% 0; }
    to { background-position: -200% 0; }
}

@keyframes flow-blood-reverse {
    from { background-position: -200% 20%; }
    to { background-position: 200% 80%; }
}

@keyframes ember-pulse {
    0%, 100% { filter: saturate(1) brightness(1) contrast(1); }
    45% { filter: saturate(1.8) brightness(1.2) contrast(1.1); }
    50% { filter: saturate(3) brightness(1.4) contrast(1.2); }  
    55% { filter: saturate(2) brightness(1.2) contrast(1.1); }
}

@keyframes magma-flow {
    0% { left: -100%; }
    30% { left: 100%; }
    100% { left: 100%; }
}

@keyframes outcast-hum {
    0%, 100% { filter: brightness(2) saturate(1); }
    50% { filter: brightness(0.5) saturate(0.5); }
}

@keyframes cosmic-drift {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}




</style>


<nav class="main-navbar">
    <div class="nav-container">
        <a href="/" class="logo">Forum<span>X</span></a>

        <div class="search-container">
            <form action="/search" method="GET" class="search-wrapper" id="searchForm">
                <span class="search-icon" id="mobileSearchTrigger">üîç</span>
                <input type="text" name="q" id="searchInput" placeholder="Lookup..." autocomplete="off">
                <span id="closeSearch" style="display:none; position:absolute; right:15px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--accent); font-weight:bold; z-index: 1002;">‚úï</span>
            </form>
        </div>

        <div class="nav-controls">
            <div class="nav-actions">
                <a href="/contribute" class="action-btn" title="New Content">
                    <span>+</span><span class="label">Upload</span>
                </a>
            </div>
            
            <div class="fx-noti-wrapper" style="margin-right: 15px;">
                <button class="dropbtn-icon" id="notiBtn" style="position: relative; border-color: transparent !important;">
                    <svg class="svg_bell" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path> <path d="M13.73 21a2 2 0 0 1-3.46 0"></path> </svg>
                    <span id="notiDot"></span>
                </button>
                <div class="fx-noti-dropdown" id="notiDropdown">
                    <div class="fx-noti-header">
                        <span>Notifications</span>
                        <div class="fx-noti-actions">
                            <button id="markAllRead" class="fx-noti-link-btn">Mark all read</button>
                            <button onclick="clearAllNotifications()" class="fx-noti-clear-btn">Clear All</button>
                        </div>
                    </div>
                    <div id="notiList" class="fx-noti-scroll-area">
                        <div class="fx-noti-loading">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="dropbtn-icon" id="settingsBtn">‚öôÔ∏è</button>
                
                <% 
                    // 1. MASTER CONFIG (Sorted high to low)
                    const ranks = [
                        { min: 10000, label: 'Death', class: 'death', icon: '‚àû' },
                        { min: 8000, label: 'God', class: 'god', icon: '‚ú¶' },
                        { min: 7000, label: 'Lucifer', class: 'lucifer', icon: 'ñ§ê' },
                        { min: 5500, label: 'Raphael', class: 'archangel', icon: 'œü' },
                        { min: 4000,  label: 'Lilith', class: 'lilith', icon: '‚ñ≤' },
                        { min: 3000,  label: 'Azazel', class: 'prince', icon: '‚óà' },
                        { min: 2000,  label: 'Leviathan', class: 'levi', icon: '‚¨¢' },
                        { min: 1000,  label: 'Alastair', class: 'torturer', icon: '‚Ä†' },
                        { min: 250,  label: 'Crowley', class: 'crowley', icon: '‚öñ' },
                        { min: 100,   label: 'Hellhounds', class: "beast", icon: '' },
                        { min: 0,    label: 'BlackEyed', class: 'noob', icon: '‚¶ø' }
                    ];

                    const multipler = 10;
                    const userPoint = user.postCount * multipler;

                    // 2. FIND CURRENT RANK
                    let currentRank = ranks.find(r => userPoint >= r.min);

                    // 3. FIND NEXT RANK
                    let nextRankIndex = ranks.findIndex(r => userPoint >= r.min) - 1;
                    let nextRank = nextRankIndex >= 0 ? ranks[nextRankIndex] : null;

                    // 4. CALCULATE BRACKET PROGRESS
                    let progress = 100;
                    if (nextRank) {
                        let currentLevelMin = currentRank.min;
                        let nextLevelMin = nextRank.min;
                        progress = ((userPoint - currentLevelMin) / (nextLevelMin - currentLevelMin)) * 100;
                    }
                %>

                <div class="dropdown-content" id="settingsDropdown">
                    <% if (currentRank.class == "death") { %>
                        <style>
                            .badge-death {
                                background: linear-gradient(135deg, #000 0%, #1a0033 45%, #4b0082 50%, #1a0033 55%, #000 100%);
                                background-size: 200% 100%;
                                color: #f3e1ff; /* Ghostly violet */
                                font-weight: 400 !important;
                                letter-spacing: 8px;
                                padding: 12px 40px;
                                clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%); /* Solid block of darkness */
                                border: 1px solid #2e004d;
                                box-shadow: 0 0 30px rgba(75, 0, 130, 0.5), inset 0 0 20px #000;
                                animation: cosmic-drift 8s infinite linear,  death-sweep 6s infinite ease-in-out;
                                text-transform: uppercase;
                            }
                            @keyframes death-sweep {
                                0%, 100% { filter: grayscale(0.2) brightness(1); letter-spacing: 8px; }
                                50% { 
                                    filter: grayscale(1) brightness(1.8); 
                                    letter-spacing: 10px;
                                    text-shadow: 0 0 20px #fff, 0 0 40px #4b0082;
                                }
                            }
                        </style>
                    <% } else if (currentRank.class == "god") { %>
                       <style>
                            .badge-god {
                                background: linear-gradient(135deg, #fff 0%, #fccd4d 50%, #f8b500 51%, #fff 100%);
                                background-size: 200% 100%;
                                color: #432c00;
                                font-size: 0.75rem;
                                padding: 12px 35px;
                                clip-path: polygon(15% 0%, 85% 0%, 100% 50%, 85% 100%, 15% 100%, 0% 50%);
                                border: none;
                                font-weight: 900;

                                display: inline-block;
                                transform: perspective(500px) rotateX(10deg) rotateY(-5deg) scale(1.1);
                                
                                box-shadow: 
                                    2px 2px 0px #b8860b, 
                                    4px 4px 0px #8b6508,
                                    0 0 30px #fff, 
                                    0 0 60px rgba(250, 188, 0, 0.4);

                                animation: god-3d-float 8s infinite ease-in-out, god-outward-glow 4s infinite;
                            }

                            /* Floating 3D motion */
                            @keyframes god-3d-float {
                                0%, 100% { 
                                    transform: perspective(500px) rotateX(10deg) rotateY(-5deg) scale(1.1); 
                                    filter: brightness(1);
                                }
                                50% { 
                                    /* Subtle tilt change as it scales */
                                    transform: perspective(500px) rotateX(15deg) rotateY(5deg) scale(1.15); 
                                    filter: brightness(1.2);
                                }
                            }

                            @keyframes god-outward-glow {
                                0%, 10%, 20%, 100% { 
                                    box-shadow: 2px 2px 0px #b8860b, 4px 4px 0px #8b6508, 0 0 30px #fff, 0 0 60px rgba(250, 188, 0, 0.4);
                                }
                                /* THE POP: The 3D shadows expand with the light */
                                12%, 16% { 
                                    box-shadow: 4px 4px 0px #fff, 8px 8px 30px #fff, 0 0 120px 40px rgba(255, 255, 255, 0.8);
                                    filter: brightness(2);
                                }
                                14% {
                                    box-shadow: 2px 2px 0px #fff, 0 0 80px 20px rgba(250, 188, 0, 1);
                                }
                            }
                        </style>
                    <% } else if (currentRank.class == "lucifer") { %>
                        <style>
                            .badge-lucifer {
                                background-size: 200% 100%;
                                padding: 20px 50px 12px 50px;
                                clip-path: polygon(10% 15%, 90% 30%, 85% 100%, 25% 90%); 
                                border: 1px solid #600;
                                font-size: 0.75rem;
                                
                                text-shadow: 0 0 8px #ff4d00;
                                background: #000;
                                color: #ff4d00;
                                box-shadow: 0 0 15px rgba(255, 0, 0, 0.7), inset 0 0 10px #7b0000;
                                animation: hellfire 3s infinite alternate;
                                position: relative;
                                overflow: hidden; 
                            }

                            .badge-lucifer::before {
                                content: '';
                                position: absolute;
                                inset: 0;
                                background: radial-gradient(circle, #fff 0%, #ff4d00 50%, transparent 70%);
                                opacity: 0;
                                mix-blend-mode: overlay;
                                pointer-events: none;
                                animation: lava-pop 5s infinite;
                            }

                            @keyframes lava-pop {
                                0%, 15%, 25%, 60%, 70%, 100% { opacity: 0; transform: scale(0.5); }
                                18% { opacity: 1; transform: scale(1.2); }
                                20% { opacity: 0; }
                                62% { opacity: 1; transform: scale(1.5); }
                                64% { opacity: 0; }
                                66% { opacity: 0.8; transform: scale(1.1); }
                                68% { opacity: 0; }
                            }
                            
                            @keyframes hellfire {
                                0% {
                                    box-shadow: 0 0 10px #ff0000, inset 0 0 5px #ff0000;
                                    filter: brightness(0.9);
                                }
                                100% {
                                    box-shadow: 0 0 30px #ff4d00, inset 0 0 10px #ff4d00;
                                    filter: brightness(2.2);
                                }
                            }

                        </style>
                    <% } else if (currentRank.class == "archangel") { %>
                        <style>
                            .badge-archangel {
                                background: linear-gradient(145deg, #001 0%, #001d6d 30%, #002ca3 50%, #001d6d 80%, #001 100%);
                                background-size: 200% 100%;
                                color: #fff;
                                font-weight: 400;
                                padding: 10px 35px;
                                clip-path: polygon(15% 0%, 100% 0%, 85% 100%, 0% 100%);
                                border: 1px solid #005e9c;
                                box-shadow: 0 0 25px rgba(0, 212, 255, 0.7), inset 0 0 15px #000;
                                text-shadow: 0 0 10px #00bfff, 0 0 20px #fff;
                                animation: cosmic-drift 3s infinite linear, lightning-strike 2s infinite;
                            }
                            @keyframes lightning-strike {
                                0%, 10%, 80%, 100% { filter: brightness(1) contrast(1); }
                                1%, 5% { filter: brightness(4) contrast(1.5) saturate(0); }
                                3%, 7% { filter: brightness(3) contrast(2) saturate(2); }
                            }
                            
                        </style>
                    <% } else if (currentRank.class == "lilith") { %>
                        <style>
                            .badge-lilith {
                                background: linear-gradient(135deg, #1a000d 0%, #4a001a 35%, #880336 50%, #4a001a 85%, #1a000d 100%);
                                background-size: 200% 100%;
                                color: #ffd4d6; 
                                font-weight: 950;
                                letter-spacing: 5px;
                                padding: 10px 30px;
                                font-size: 0.95rem;
                                font-weight: 400;
                                clip-path: polygon(0% 15%, 100% 0%, 85% 85%, 15% 100%); 
                                border-top: 1px solid rgba(255, 255, 255, 0.4);
                                border-bottom: 2px solid #8a1b46;
                                box-shadow: 
                                    0 8px 15px rgba(0,0,0,0.9), 
                                    inset 0 0 20px #000,
                                    0 0 15px rgba(138, 27, 70, 0.5);

                                    animation: 
                                    flow-blood 6s infinite linear, 
                                    lilith-radiance 6s infinite ease-in-out;
                                
                                text-shadow: 0 0 8px rgba(255, 8, 8, 0.6), 0 0 15px rgba(255, 179, 204, 0.4);
                                position: relative;
                                overflow: hidden;
                            }

                            @keyframes lilith-radiance {
                                0%, 100% { filter: brightness(1) contrast(1); }
                                50% { filter: brightness(1.3) contrast(1.2); }
                            }

                        </style> 
                    <% } else if (currentRank.class == "prince") { %>
                        <style>
                            .badge-prince {
                                /* background: linear-gradient(135deg, #020 0%, #050 45%, #0f0 50%, #050 55%, #020 100%); */
                                /* color: rgb(170, 255, 170); */
                                
                                background: linear-gradient(135deg, 
                                #000000 0%,    
                                #1a1500 45%, 
                                #ffcc00 50%,  
                                #1a1500 55%, 
                                #000000 100%  
                                );
                                color: #fff2b3;    
                                text-shadow: 0 0 5px rgba(255, 204, 0, 0.6);

                                border: 1px solid #010;
                                background-size: 200% 100%;
                                box-shadow: 
                                inset 0 0 15px #000, 
                                0 4px 10px rgba(0,0,0,0.8);
                                clip-path: polygon(0% 25%, 90% 0%, 85% 100%, 15% 80%); 
                                filter: sepia(0.1);
                                animation: flow-blood-reverse 5s infinite linear;
                                font-size: 1rem;
                            }

                        </style>
                    <% } else if (currentRank.class == "levi") { %>
                        <style>
                            .badge-levi {
                                background: linear-gradient(160deg, #001 0%, #002e5c 40%, #00d4ff 50%, #002e5c 60%, #001 100%);
                                background-size: 200% 100%;
                                color: #fff;
                                font-size: 0.75rem;
                                padding: 10px 28px;
                                border: 1px solid #00d4ff;
                                /* "The Fin" - Massive, sweeping pressure shape */
                                clip-path: polygon(15% 0%, 100% 25%, 85% 100%, 0% 75%);
                                box-shadow: 
                                    0 0 25px rgba(0, 212, 255, 0.6), 
                                    inset 0 0 20px #000;
                                filter: drop-shadow(0 0 12px #00d4ff);
                                animation: flow-blood-reverse 4s infinite linear reverse;
                            }
                        </style>
                    <% } else if (currentRank.class == "torturer") { %>
                        <style>
                            .badge-torturer {
                                /* Blood-soaked leather texture */
                                background: radial-gradient(circle at center, #4a0000 0%, #1a0000 70%, #000 100%);
                                color: #ffcccc; 
                                font-weight: 900;
                                letter-spacing: 4px;
                                padding: 12px 35px;
                                
                                clip-path: polygon(5% 0%, 95% 2%, 100% 50%, 95% 98%, 5% 100%, 0% 50%);
                                border: 1px solid #700;
                                box-shadow: 
                                    0 0 15px rgba(255, 0, 0, 0.4),
                                    inset 0 0 25px #000;

                                animation: torturer-throb 4s infinite ease-in-out;
                                text-shadow: 0 0 8px #f00;
                                font-size: 0.85rem;
                            }

                            @keyframes torturer-throb {
                                0%, 100% { 
                                    filter: brightness(1) contrast(1.2);
                                    transform: scale(1);
                                }
                                50% { 
                                    filter: brightness(0.7) contrast(1.5);
                                    transform: scale(0.98); /* Slight contraction like a muscle */
                                    color: #ff0000;
                                }
                            }

                            /* Adding the "White Eye" signature: A pale glow on the text */
                            .badge-torturer::before {
                                content: '';
                                position: absolute;
                                top: 0; left: 0;
                                width: 100%; height: 100%;
                                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
                                animation: metal-shimmer 3s infinite;
                            }
                        </style>
                    <% } else if (currentRank.class == "crowley") { %>
                        <style>
                            .badge-crowley {
                                background: linear-gradient(135deg, #1a0000 0%, #4a0000 45%, #ff0000 50%, #4a0000 55%, #1a0000 100%);
                                background-size: 200% 100%;
                                color: #ff5858; 
                                font-weight: 900;
                                padding: 11px 38px;
                                clip-path: polygon(10% 0%, 100% 0%, 90% 100%, 0% 100%);
                                border: 1px solid #800;
                                box-shadow: 0 0 20px rgba(255, 0, 0, 0.5), inset 0 0 15px #000;
                                animation: flow-blood 5s infinite linear;
                            }
                            /* The Red Eye glow in the corner */
                            .badge-crowley::after {
                                content: ''; position: absolute; top: 5px; right: 10px;
                                width: 5px; height: 5px; background: #f00; border-radius: 50%;
                                box-shadow: 0 0 12px #f00;
                            }
                        </style>
                    <% } else if (currentRank.class == "beast") { %>
                        <style>
                        .badge-beast {
                            /* The "Black Smoke" Body */
                            background: linear-gradient(135deg, #000 0%, #150000 50%, #000 100%);
                            color: #eee;
                            font-weight: 950;
                            letter-spacing: 5px;
                            padding: 12px 30px;

                            /* THE CLAW SHAPE: Aggressive, triple-pointed jagged edges */
                            clip-path: polygon(
                                0% 20%, 5% 0%, 95% 10%, 100% 20%, 
                                90% 45%, 100% 60%, 90% 75%, 100% 100%, 
                                5% 90%, 0% 100%, 10% 50%
                            );

                            /* The "Fresh Wound" Glow */
                            border-left: 3px solid #600;
                            box-shadow: 
                                -5px 0 15px #f00, 
                                inset 0 0 20px #000;

                            /* Animation: The "Predator Pant" (Heavy, rhythmic pulsing) */
                            animation: hound-hunt 1.5s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95);
                            text-shadow: 2px 2px 4px #000;
                            position: relative;
                        }

                        @keyframes hound-hunt {
                            0%, 100% { 
                                transform: scale(1) skewX(0deg); 
                                filter: brightness(1) saturate(1.2); 
                            }
                            50% { 
                                transform: scale(1.05) skewX(-2deg); 
                                filter: brightness(1.5) saturate(2);
                                /* The color "flushes" like blood rushing to the surface */
                                background: #2a0000; 
                            }
                        }

                        /* The "Shadow Teeth" effect: subtle dark moving streaks */
                        .badge-beast::before {
                            content: '';
                            position: absolute;
                            inset: 0;
                            background: repeating-linear-gradient(
                                45deg,
                                transparent,
                                transparent 10px,
                                rgba(0, 0, 0, 0.5) 10px,
                                rgba(0, 0, 0, 0.5) 20px
                            );
                            opacity: 0.3;
                        }
                    </style>
                    <% } else if (currentRank.class == "noob") { %>
                        <style>
                            .badge-noob { background: transparent; color: #9c9c9c; border: 1px dashed #333; clip-path: none; font-size: 0.7rem; font-weight: 900; }
                        </style>
                    <% } %>

                    <div class="user-info">

                        <div class="rank-header" style="margin: 15px; display: flex; align-items: center;justify-content: center;">
                            <span class="badge badge-<%= currentRank.class %>">
                                <%= currentRank.icon %> <%= currentRank.label %>
                            </span>

                            <div class="badge-help" >
                                <span class="help-icon">‚ìò</span>
                            </div>
                        </div>
                        
                        <small style="margin-top: 20px;">SIGNED IN AS</small>
                        <div style="display: flex; align-items: center; gap: 10px; position: relative;">
                            <div class="pulse-indicator" title="Live Session Active"></div>
                            <strong style="letter-spacing: 1px;"><a style="color: var(--white); text-decoration: none; font-size: 1.5rem;" href="/user/<%= user.id %>" ><%= user.username %></a></strong>
                        </div>
                        <p style="margin: 20px 0 5px 0; font-size: 0.9rem; color: var(--text-dim); opacity: 0.9;"><span style="font-size: 0.8rem;">Points: </span> <%= userPoint %> <span style="color: var(--accent);">ñ§ê</span></p>

                        <div class="badge-tooltip">
                            <div class="tooltip-title">System Hierarchy</div>
                            <table>
                                <% [...ranks].reverse().forEach(rank => { %>
                                    <tr class="<%= userPoint >= rank.min ? 'rank-unlocked' : 'rank-locked' %>">
                                        <td><%= rank.icon %> <%= rank.label %></td>
                                        <td><%= rank.min %>+</td>
                                    </tr>
                                <% }); %>
                            </table>
                            
                            <div class="tooltip-footer">
                                <% if (nextRank) { %>
                                    EST. UPLINK: <strong><%= nextRank.label %></strong> IN <%= nextRank.min - userPoint %> UNITS
                                <% } else { %>
                                    <span class="glitch-text">MAX LEVEL REACHED</span>
                                <% } %>
                            </div>
                        </div>

                        <div class="user-progress-container" style="padding: 10px 0; margin-top: 2px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.6rem; color: #888; margin-bottom: 6px; text-transform: uppercase; font-weight: 900;">
                                <span>Next Phase: <%= nextRank ? nextRank.label : 'N/A' %></span>
                                <span><%= Math.floor(progress) %>%</span>
                            </div>

                            <div class="progress-bar-bg" style="height: 6px; background: #111; border-radius: 0;">
                                <div class="progress-bar-fill" style="--p:<%= progress %>%; height: 100%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); width: var(--p); "></div>
                            </div>
                        </div>

                    </div>
                    
                    
                    <div class="dropdown-section-title">Extra Navigation</div>
                    
                    <button onclick="window.location.href='/categories'">
                        <div class="btn-label">
                            <span>üè∑Ô∏è</span>
                            <span>Categories</span>
                        </div>
                        <span class="chevron">‚Ä∫</span>
                    </button>
                    
                    
                    <button onclick="window.location.href='/requests'">
                        <div class="btn-label">
                            <span style="display: flex; align-items: center; justify-content: center; width: 20px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    <line x1="12" y1="7" x2="12" y2="13"></line>
                                    <line x1="9" y1="10" x2="15" y2="10"></line>
                                </svg>
                            </span>
                            <span>Request</span>
                        </div>
                        <span class="chevron">‚Ä∫</span>
                    </button>
                    
                    <% if (user && user.isAdmin == 1) { %>
                        <div class="dropdown-section-title">Admin Only</div>
                        <button onclick="window.location.href='/drafts'">
                            <div class="btn-label">
                                <span>üïî</span>
                                <span>Saved Drafts</span>
                            </div>
                            <span class="chevron">‚Ä∫</span>
                        </button>
                    <% } %>


                    <div class="dropdown-section-title">Interface</div>
                    
                    <button id="imageToggle" class="status-on">
                        <div class="btn-label">
                            <span>üñºÔ∏è</span>
                            <span>Images Visible</span>
                        </div>
                        <div class="switch"></div>
                    </button>
                    
                    <button id="editModeToggle" class="status-on">
                        <div class="btn-label">
                            <span>‚úèÔ∏è</span>
                            <span>Edit Mode</span>
                        </div>
                        <div class="switch"></div>
                    </button>
                    
                    <div class="dropdown-section-title">Security</div>
                    
                    <button id="openPassModal">
                        <div class="btn-label">
                            <span>üîë</span>
                            <span>Change Password</span>
                        </div>
                        <span class="chevron">‚Ä∫</span>
                    </button>

                    <hr class="dropdown-divider">
                    
                    <button style="margin-bottom: 10px;" onclick="confirm('Logout?') ? window.location.href='/logout' : ''" class="logout-btn">
                        <span>üí® Logout</span>
                    </button>
                </div>
            </div>

        </div>
    </div>
</nav>  

<div id="passwordModal" class="fx-modal-overlay">
    <div class="fx-modal-content">
        <div class="fx-modal-header">
            <h3>Update Security</h3>
            <button class="fx-close-modal">&times;</button>
        </div>
        <form id="passwordForm" action="/update-password" method="POST">
            <div class="fx-input-group">
                <label>Current Password</label>
                <input type="password" name="currentPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="fx-input-group">
                <label>New Password</label>
                <input type="password" name="newPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="fx-input-group">
                <label>Repeat New Password</label>
                <input type="password" name="confirmPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button type="submit" class="fx-save-btn">Update Password</button>
        </form>
    </div>
</div>

<div id="toastContainer" class="fx-toast-container"></div>

<!-- Search + Info JS -->
<script>

    document.addEventListener('DOMContentLoaded', () => {
        // Search Bar Logic
            const searchTrigger = document.getElementById('mobileSearchTrigger');
            const searchInput = document.getElementById('searchInput');
            const closeSearch = document.getElementById('closeSearch');

            searchTrigger.addEventListener('click', (e) => {
                // Only run this logic on small screens
                if (window.innerWidth <= 600) {
                    e.preventDefault(); // Prevent form submission if clicked
                    document.body.classList.add('search-open');
                    closeSearch.style.display = 'block';
                    
                    // Focus the input so the user can type immediately
                    setTimeout(() => {
                        searchInput.focus();
                    }, 100);
                }
            });

            closeSearch.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.body.classList.remove('search-open');
                searchInput.value = '';
                closeSearch.style.display = 'none';
            });

        // Other Logics
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');
        const passModal = document.getElementById('passwordModal');
        const openPassBtn = document.getElementById('openPassModal');
        const closePassBtn = document.querySelector('.fx-close-modal');
        const passwordForm = document.getElementById('passwordForm');
        const body = document.body;

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (settingsDropdown.classList.contains('active')) {
                if (!settingsDropdown.contains(e.target) && e.target !== settingsBtn) {
                    settingsDropdown.classList.remove('active');
                }
            }
        });

        openPassBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            settingsDropdown.classList.remove('active'); 
            passModal.classList.add('active');
        });

        closePassBtn.addEventListener('click', () => {
            passModal.classList.remove('active');
        });

        // passModal.addEventListener('click', (e) => {
        //     if (e.target === passModal) {
        //         passModal.classList.remove('active');
        //     }
        // });

        // --- TOGGLE LOGIC (Images) ---
        const imageBtn = document.getElementById('imageToggle');
        const updateImages = (hide) => {
            body.classList.toggle('hide-images', hide);
            imageBtn.classList.toggle('status-on', !hide);
        };

        imageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const hide = !body.classList.contains('hide-images');
            localStorage.setItem('hideForumImages', hide);
            updateImages(hide);
        });

        // --- TOGGLE LOGIC (Edit Mode) ---
        const editModeBtn = document.getElementById('editModeToggle');
        const updateEditMode = (hide) => {
            body.classList.toggle('hide-edit-active', hide);
            editModeBtn.classList.toggle('status-on', !hide);
        };

        editModeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isNowHidden = body.classList.contains('hide-edit-active');
            const nextState = !isNowHidden;
            localStorage.setItem('hideEditBtn', nextState);
            updateEditMode(nextState);
        });

        passwordForm.addEventListener('submit', (e) => {
            const submitBtn = passwordForm.querySelector('.fx-save-btn');
            const newPass = passwordForm.elements['newPassword'].value;
            const confirmPass = passwordForm.elements['confirmPassword'].value;

            // 1. Validate
            if (newPass !== confirmPass) {
                e.preventDefault();
                alert("New passwords do not match!");
                return;
            }

            // 2. Loading State
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<div class="fx-spinner"></div> Updating...`;
        });

        // --- TOAST NOTIFICATION SYSTEM ---
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `fx-toast ${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            
            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('fx-toast-fade-out');
                setTimeout(() => toast.remove(), 400);
            }, 4000);
        };

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('status')) {
            const status = urlParams.get('status');
            if (status === 'updated') showToast('Security updated successfully!', 'success');
            if (status === 'error') showToast('Failed to update security.', 'error');
            
            // Clean up the URL so the toast doesn't reappear on manual refresh
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // --- INITIALIZE STATES ---
        updateImages(localStorage.getItem('hideForumImages') === 'true');
        updateEditMode(localStorage.getItem('hideEditBtn') === 'true');
    });

    
</script>

<!-- Notification JS -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const notiBtn = document.getElementById('notiBtn');
        const notiDropdown = document.getElementById('notiDropdown');
        const notiDot = document.getElementById('notiDot');
        const notiList = document.getElementById('notiList');

        // 1. Fetch notifications and update Red Dot
        async function checkNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const notifications = await response.json();
                
                const unreadCount = notifications.filter(n => !n.is_read).length;

                if (unreadCount > 0) {
                    notiDot.style.display = 'flex'; // Use flex to center text
                    
                    if (unreadCount > 9) {
                        notiDot.innerText = '9+';
                    } else {
                        notiDot.innerText = unreadCount;
                    }
                } else {
                    notiDot.style.display = 'none';
                }
                
                renderNotifications(notifications);
            } catch (err) {
                console.error('Failed to load notifications');
            }
        }

        // 2. Build the list inside the dropdown
        function renderNotifications(notis) {
            if (notis.length === 0) {
                notiList.innerHTML = `<div class="fx-noti-loading">No notifications yet</div>`;
                return;
            }

            // Icon & Color mapping
            const meta = {
                comment:      { icon: 'üí¨', color: '#4dabf7' }, // Blue
                mention:      { icon: 'üë§', color: '#ae3ec9' }, // Purple
                rank_up:      { icon: 'üèÜ', color: '#fcc419' }, // Gold
                rq_pending: { icon: 'üì¶', color: '#e2d14a' }, // Green
                rq_finish: { icon: 'üöö', color: '#51cf66' }, // Green
                system:       { icon: 'üì¢', color: '#ff6b6b' }  // Red
            };

            notiList.innerHTML = notis.map(n => {
                const typeMeta = meta[n.type] || { icon: 'üîî', color: 'var(--accent)' };
                
                return `
                    <div class="fx-noti-item ${n.is_read ? '' : 'fx-noti-unread'}" 
                        onclick="handleNotiClick(${n.id}, ${n.post_id}, ${n.link_url ? `'${n.link_url}'` : 'null'})">
                        <div class="fx-noti-content-row">
                            <span class="fx-noti-icon" style="color: ${typeMeta.color}">${typeMeta.icon}</span>
                            <div class="fx-noti-text-wrapper">
                                <p>${n.message}</p>
                                <small>${formatTime(n.created_at)}</small>
                            </div>
                        </div>
                        <button class="fx-noti-delete" onclick="deleteNotification(event, ${n.id})">&times;</button>
                    </div>
                `;
            }).join('');
        }

        // 3. Handle Click: Mark as read then Redirect
        window.handleNotiClick = async (id, postId, linkUrl) => {
            // 1. Mark as read
            await fetch(`/api/notifications/${id}/read`, { method: 'POST' });

            // 2. Decide where to go
            if (linkUrl) {
                window.location.href = linkUrl; // Go to custom link (e.g., /profile/settings)
            } else if (postId) {
                window.location.href = `/forum/post/${postId}`; // Go to post
            } else {
                // Fallback: refresh or stay on page if no link exists
                location.reload(); 
            }
        };

        // Function to delete one
        window.deleteNotification = async (event, id) => {
            event.stopPropagation();
            
            // Updated URL and Method
            const res = await fetch(`/api/notifications/${id}/delete`, { method: 'POST' }); 
            
            if (res.ok) {
                const item = event.target.closest('.fx-noti-item');
                item.style.opacity = '0';
                setTimeout(() => {
                    item.remove();
                    checkNotifications(); // Refresh the red dot
                }, 200);
            }
        };

        // Function to clear everything
        window.clearAllNotifications = async () => {
            if (!confirm("Are you sure to clear all notifications?")) return;

            // Updated Method
            const res = await fetch('/api/notifications/clear-all', { method: 'POST' });
            
            if (res.ok) {
                notiList.innerHTML = '<div class="fx-noti-loading">No notifications yet</div>';
                document.getElementById('notiDot').style.display = 'none';
            }
        };
        
        // Helper: Simple Time Formatter
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function checkEmptyState() {
            if (notiList.children.length === 0) {
                notiList.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-dim); font-size:0.8rem;">No notifications yet</div>`;
            }
        }


        // Add this inside your DOMContentLoaded block
        const markAllReadBtn = document.getElementById('markAllRead');
        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!confirm("Are you sure to mark all notifications as read?")) return;

                try {
                    const res = await fetch('/api/notifications/mark-all-read', { method: 'POST' });
                    if (res.ok) {
                        notiDot.style.display = 'none';
                        // Update all items in the UI to look "read"
                        document.querySelectorAll('.fx-noti-unread').forEach(item => {
                            item.classList.remove('fx-noti-unread');
                        });
                    }
                } catch (err) {
                    console.error("Mark all read failed", err);
                }
            });
        }


        
        // Change from 60000 (1 min) to 300000 (5 mins) * 12 = 1 hour
        const POLL_INTERVAL = 300000 * 12; 

        // 1. Initial check when page loads
        checkNotifications(); 

        // 2. Periodic check (Background)
        setInterval(() => {
            if (!document.hidden) {
                checkNotifications();
            }
        }, POLL_INTERVAL);
        
        // 3. Dropdown Click (Immediate Update)
        notiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpening = !notiDropdown.classList.contains('show');
            
            notiDropdown.classList.toggle('show');
            settingsDropdown.classList.remove('active');

            if (isOpening) {
                checkNotifications(); 
            }
        });

    });


window.addEventListener('click', () => {
    if (notiDropdown.classList.contains('show')) {
        notiDropdown.classList.remove('show');
    }
});

notiDropdown.addEventListener('click', (e) => {
    e.stopPropagation();
});

</script>
